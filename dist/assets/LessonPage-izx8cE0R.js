import{d as Y,c as P,r as c,p as H,z as te,o as v,b as k,f as d,B as se,s as O,C as Q,k as N,i as D,w as u,g as i,t as E,n as le,e as m,j as oe,m as F,_ as Z,u as ae,x as z,D as ne,h as R,F as K,q as re,l as ue}from"./index-CT7pwcoW.js";import{H as ie,A as ve}from"./AppFooter-D9xrkYWh.js";import{c as X}from"./courseService-BbW8dK5y.js";import{c as ce}from"./courseUserService-CacPPWF5.js";const b={started:new Set,completed:new Set,inProgress:new Set},G={isLessonStarted(a){return b.started.has(a)},markLessonAsStarted(a){b.started.add(a)},isLessonCompleted(a){return b.completed.has(a)},markLessonAsCompleted(a){b.completed.add(a)},isRequestInProgress(a){return b.inProgress.has(a)},startRequest(a){b.inProgress.add(a)},finishRequest(a){b.inProgress.delete(a)},resetLessonState(a){b.started.delete(a),b.completed.delete(a)},resetAllStates(){b.started.clear(),b.completed.clear(),b.inProgress.clear()}},de=["poster"],me=["src","type"],fe={class:"video-progress"},pe={class:"controls-main"},ge={class:"volume-control"},_e={class:"time-display"},ye=Y({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(a){const U=a,w=P(()=>{if(!U.videoUrl)return"video/avi";switch(U.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),j=l=>{if(!l)return"/public/default-lesson.jpg";let s=l.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},o=c(null),n=c(null),x=c(!1),L=c(0),S=c(0),T=c(0),r=c(1),g=c(!1),_=c(!1),I=c(!0);let h=null;const f=()=>{I.value=!0,h&&clearTimeout(h),h=setTimeout(()=>{x.value&&(I.value=!1)},3e3)},p=()=>{o.value&&(x.value?o.value.pause():o.value.play(),x.value=!x.value,f())},$=()=>{o.value&&(L.value=o.value.currentTime,T.value=L.value/S.value*100)},A=()=>{o.value&&(S.value=o.value.duration)},B=()=>{if(!o.value)return;const l=T.value/100*S.value;o.value.currentTime=l},W=()=>{o.value&&(o.value.volume=r.value,g.value=r.value===0)},M=()=>{o.value&&(g.value?(g.value=!1,r.value=r.value===0?1:r.value,o.value.volume=r.value):(g.value=!0,o.value.volume=0))},V=()=>{n.value&&(document.fullscreenElement?(document.exitFullscreen(),_.value=!1):(n.value.requestFullscreen(),_.value=!0))},q=()=>{_.value=!!document.fullscreenElement},t=l=>{const s=Math.floor(l/60),y=Math.floor(l%60);return`${s}:${y<10?"0":""}${y}`},e=l=>{(document.activeElement===o.value||document.activeElement===n.value||_.value)&&(l.code==="Space"?(p(),l.preventDefault()):l.code==="ArrowRight"?(o.value&&(o.value.currentTime+=10),f()):l.code==="ArrowLeft"?(o.value&&(o.value.currentTime-=10),f()):l.code==="KeyM"?(M(),f()):l.code==="KeyF"&&(V(),f()))};return H(()=>{window.addEventListener("keydown",e),document.addEventListener("fullscreenchange",q),n.value&&n.value.addEventListener("mousemove",f),o.value&&(o.value.volume=r.value)}),te(()=>{window.removeEventListener("keydown",e),document.removeEventListener("fullscreenchange",q),n.value&&n.value.removeEventListener("mousemove",f),h&&clearTimeout(h)}),(l,s)=>{const y=F("v-icon");return v(),k("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:n},[d("video",{ref_key:"videoPlayer",ref:o,onTimeupdate:$,onLoadedmetadata:A,onEnded:s[0]||(s[0]=C=>x.value=!1),onClick:p,poster:a.posterImage},[d("source",{src:j(a.videoUrl),type:w.value},null,8,me)],40,de),d("div",{class:le(["video-controls",{"controls-visible":I.value}])},[d("div",fe,[d("div",{class:"progress-bar",style:se({width:`${T.value}%`})},null,4),O(d("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=C=>T.value=C),onInput:B},null,544),[[Q,T.value]])]),d("div",pe,[d("button",{class:"control-btn",onClick:N(p,["stop"])},[x.value?(v(),D(y,{key:1},{default:u(()=>s[4]||(s[4]=[i("mdi-pause")])),_:1})):(v(),D(y,{key:0},{default:u(()=>s[3]||(s[3]=[i("mdi-play")])),_:1}))]),d("div",ge,[d("button",{class:"control-btn",onClick:N(M,["stop"])},[g.value?(v(),D(y,{key:0},{default:u(()=>s[5]||(s[5]=[i("mdi-volume-off")])),_:1})):r.value<.5?(v(),D(y,{key:1},{default:u(()=>s[6]||(s[6]=[i("mdi-volume-low")])),_:1})):(v(),D(y,{key:2},{default:u(()=>s[7]||(s[7]=[i("mdi-volume-high")])),_:1}))]),O(d("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=C=>r.value=C),onInput:W},null,544),[[Q,r.value]])]),d("div",_e,E(t(L.value))+" / "+E(t(S.value)),1),d("button",{class:"control-btn fullscreen-btn",onClick:N(V,["stop"])},[_.value?(v(),D(y,{key:0},{default:u(()=>s[8]||(s[8]=[i("mdi-fullscreen-exit")])),_:1})):(v(),D(y,{key:1},{default:u(()=>s[9]||(s[9]=[i("mdi-fullscreen")])),_:1}))])])],2),x.value?oe("",!0):(v(),k("div",{key:0,class:"big-play-button",onClick:N(p,["stop"])},[m(y,{size:"64"},{default:u(()=>s[10]||(s[10]=[i("mdi-play")])),_:1})]))],512)}}}),be=Z(ye,[["__scopeId","data-v-2135aa7c"]]),ke={class:"page-wrapper"},we={key:0,class:"d-flex justify-center my-5"},Ie={key:1,class:"error-message"},he={key:2},xe={key:0,class:"breadcrumbs-container"},Ue={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Le={class:"content-wrapper flex-column"},$e={class:"video-block mb-0 pt-0"},Se={class:"font-weight-medium mb-3"},Te={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Ce=Y({__name:"LessonPage",setup(a){const{mdAndDown:U}=ae(),w=re(),j=ue(),o=c(),n=c(""),x=c(""),L=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e};H(async()=>{const t=w.params.lessonId,e=localStorage.getItem(`lesson_image_${t}`);e&&(n.value=e,localStorage.removeItem(`lesson_image_${t}`)),await Promise.all([S(),V()]),!n.value&&_.value.imageUrl&&(n.value=L(_.value.imageUrl))});const S=async()=>{let e=0;for(;e<3;)try{r.value=!0;const l=await X.getLessonDetails(f.value);return _.value=l,l}catch(l){if(e++,console.error(`Ошибка при загрузке урока (попытка ${e}/3):`,l),e>=3)throw g.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",l;await new Promise(s=>setTimeout(s,1e3*e))}finally{r.value=!1}},T=async t=>{if(t){r.value=!0,g.value="";try{const e=await ce.fetchCourseWithBlocks(t);x.value=e.courseTitle||"Курс без названия",o.value=e.imageUrl}catch(e){console.error("Ошибка при загрузке курса:",e),g.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{r.value=!1}}};H(()=>{const t=w.params.courseId;t&&(I.value=t,T(t))});const r=c(!0),g=c(""),_=c({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),I=P(()=>w.params.courseId),h=P(()=>w.params.blocksId),f=P(()=>w.params.lessonId),p=c([]),$=P(()=>{const t=f.value?String(f.value):null;return p.value.findIndex(e=>{const l=e.id?String(e.id):null,s=e.lessonId?String(e.lessonId):null;return l===t||s===t})}),A=P(()=>{if($.value>0){const t=p.value[$.value-1];return t.id||t.lessonId}return null}),B=P(()=>{if($.value<p.value.length-1&&$.value!==-1){const t=p.value[$.value+1];return t.id||t.lessonId}return null});c(!1);const W=async()=>{if(!B.value){console.log("Нет следующего урока");return}if(B.value){const t=`/course/${I.value}/blocks/${h.value}/lessons/${B.value}`;j.push(t)}},M=P(()=>$.value!==-1&&$.value===p.value.length-1);z(p,()=>{},{immediate:!0}),z([()=>w.params.courseId,()=>w.params.blocksId],([t,e])=>{t&&e&&V()});const V=async()=>{try{const t=await X.getLessonsByBlockId(h.value);p.value=t||[]}catch(t){console.error("Ошибка при загрузке списка уроков:",t),g.value="Не удалось загрузить список уроков. Пожалуйста, попробуйте позже."}};z(()=>w.params.lessonId,(t,e)=>{t&&t!==e&&(_.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},r.value=!0,S())},{immediate:!0}),z(()=>w.params.lessonId,t=>{if(t){const e=localStorage.getItem(`lesson_image_${t}`);if(e)n.value=e,localStorage.removeItem(`lesson_image_${t}`);else{const l=p.value.find(s=>(s.id||s.lessonId)===t);l&&(l.imageUrl||l.lessonImage)?n.value=L(l.imageUrl||l.lessonImage):n.value=""}}},{immediate:!0});const q=()=>{if(!A.value){console.log("Нет предыдущего урока");return}const t=p.value.find(e=>(e.id||e.lessonId)===A.value);if(t&&(t.imageUrl||t.lessonImage)){const e=L(t.imageUrl||t.lessonImage);console.log("Сохраняем изображение предыдущего урока:",e),localStorage.setItem(`lesson_image_${A.value}`,e)}typeof G<"u"&&G.resetLessonState(f.value),j.push(`/course/${I.value}/blocks/${h.value}/lessons/${A.value}`)};return ne(()=>{f.value&&G.resetLessonState(f.value)}),H(async()=>{try{r.value=!0,await T(I.value);const t=await S();if(await V(),t&&t.imageUrl)n.value=L(t.imageUrl);else{const e=localStorage.getItem(`lesson_image_${f.value}`);e?n.value=e:n.value="/public/default-lesson.jpg"}}catch(t){g.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",t)}finally{r.value=!1}}),(t,e)=>{const l=F("v-progress-circular"),s=F("v-breadcrumbs-item"),y=F("v-breadcrumbs"),C=F("v-btn"),J=F("v-icon"),ee=F("v-container");return v(),k("div",ke,[m(ie),m(ee,{fluid:"",class:"content-container px-6 pt-2",width:R(U)?"100vw":"60vw"},{default:u(()=>[r.value?(v(),k("div",we,[m(l,{indeterminate:"",color:"#F48A21"})])):g.value?(v(),k("div",Ie,E(g.value),1)):(v(),k("div",he,[R(U)?(v(),k("div",Ue,[m(C,{variant:"outlined",density:"comfortable",to:`/course/${I.value}/blocks/${h.value}`,class:"back-button text-none"},{default:u(()=>e[3]||(e[3]=[i(" К урокам ")])),_:1},8,["to"])])):(v(),k("div",xe,[m(y,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:u(()=>[m(s,{to:"/lk"},{default:u(()=>e[1]||(e[1]=[i("Профиль")])),_:1}),m(s,{to:`/course/${I.value}`},{default:u(()=>[i(E(x.value),1)]),_:1},8,["to"]),m(s,{to:`/course/${I.value}/blocks/${h.value}`},{default:u(()=>e[2]||(e[2]=[i("Уроки")])),_:1},8,["to"]),m(s,{disabled:""},{default:u(()=>[i(E(_.value.lessonTitle),1)]),_:1})]),_:1})])),d("div",Le,[d("div",$e,[d("h2",Se,E(_.value.lessonTitle),1),m(be,{"video-url":_.value.videoUrl,"poster-image":L(n.value)},null,8,["video-url","poster-image"]),d("div",Te,[m(C,{class:"text-none rounded-lg",width:R(U)?"40vw":"regular",variant:"outlined",onClick:q,disabled:!A.value},{default:u(()=>[R(U)?(v(),k(K,{key:0},[m(J,null,{default:u(()=>e[4]||(e[4]=[i("mdi-arrow-left")])),_:1}),e[5]||(e[5]=i(" Предыдущий "))],64)):(v(),k(K,{key:1},[i(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),m(C,{class:"text-none rounded-lg ml-4",width:R(U)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:e[0]||(e[0]=Pe=>W())},{default:u(()=>[R(U)?(v(),k(K,{key:0},[i(E(M.value?"Завершить":"Следующий")+" ",1),m(J,null,{default:u(()=>e[6]||(e[6]=[i("mdi-arrow-right")])),_:1})],64)):(v(),k(K,{key:1},[i(E(M.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])])])]))]),_:1},8,["width"]),m(ve)])}}}),Ve=Z(Ce,[["__scopeId","data-v-11597b95"]]);export{Ve as default};
