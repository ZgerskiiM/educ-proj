import{d as Z,c as T,r as v,p as W,z as se,o as c,b as k,f as m,B as le,s as Q,C as X,k as K,i as E,w as u,g as i,t as C,n as oe,e as f,j as ae,m as A,_ as ee,u as ne,x as V,D as re,h as R,F as H,q as ue,l as ie}from"./index-DVyF8z1k.js";import{H as ve,A as ce}from"./AppFooter-BfDJsup2.js";import{c as Y}from"./courseService-B4wVh4Yq.js";import{c as de}from"./courseUserService-DRg3sHLg.js";const b={started:new Set,completed:new Set,inProgress:new Set},J={isLessonStarted(n){return b.started.has(n)},markLessonAsStarted(n){b.started.add(n)},isLessonCompleted(n){return b.completed.has(n)},markLessonAsCompleted(n){b.completed.add(n)},isRequestInProgress(n){return b.inProgress.has(n)},startRequest(n){b.inProgress.add(n)},finishRequest(n){b.inProgress.delete(n)},resetLessonState(n){b.started.delete(n),b.completed.delete(n)},resetAllStates(){b.started.clear(),b.completed.clear(),b.inProgress.clear()}},me=["poster"],fe=["src","type"],pe={class:"video-progress"},ge={class:"controls-main"},_e={class:"volume-control"},ye={class:"time-display"},be=Z({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(n){const x=n,y=T(()=>{if(!x.videoUrl)return"video/avi";switch(x.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),q=e=>{if(!e)return"/public/default-lesson.jpg";let s=e.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},l=v(null),r=v(null),I=v(!1),$=v(0),U=v(0),S=v(0),a=v(1),p=v(!1),g=v(!1),h=v(!0);let w=null;const d=()=>{h.value=!0,w&&clearTimeout(w),w=setTimeout(()=>{I.value&&(h.value=!1)},3e3)},_=()=>{l.value&&(I.value?l.value.pause():l.value.play(),I.value=!I.value,d())},L=()=>{l.value&&($.value=l.value.currentTime,S.value=$.value/U.value*100)},P=()=>{l.value&&(U.value=l.value.duration)},B=()=>{if(!l.value)return;const e=S.value/100*U.value;l.value.currentTime=e},M=()=>{l.value&&(l.value.volume=a.value,p.value=a.value===0)},N=()=>{l.value&&(p.value?(p.value=!1,a.value=a.value===0?1:a.value,l.value.volume=a.value):(p.value=!0,l.value.volume=0))},j=()=>{r.value&&(document.fullscreenElement?(document.exitFullscreen(),g.value=!1):(r.value.requestFullscreen(),g.value=!0))},D=()=>{g.value=!!document.fullscreenElement},z=e=>{const s=Math.floor(e/60),o=Math.floor(e%60);return`${s}:${o<10?"0":""}${o}`},t=e=>{(document.activeElement===l.value||document.activeElement===r.value||g.value)&&(e.code==="Space"?(_(),e.preventDefault()):e.code==="ArrowRight"?(l.value&&(l.value.currentTime+=10),d()):e.code==="ArrowLeft"?(l.value&&(l.value.currentTime-=10),d()):e.code==="KeyM"?(N(),d()):e.code==="KeyF"&&(j(),d()))};return W(()=>{window.addEventListener("keydown",t),document.addEventListener("fullscreenchange",D),r.value&&r.value.addEventListener("mousemove",d),l.value&&(l.value.volume=a.value)}),se(()=>{window.removeEventListener("keydown",t),document.removeEventListener("fullscreenchange",D),r.value&&r.value.removeEventListener("mousemove",d),w&&clearTimeout(w)}),(e,s)=>{const o=A("v-icon");return c(),k("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:r},[m("video",{ref_key:"videoPlayer",ref:l,onTimeupdate:L,onLoadedmetadata:P,onEnded:s[0]||(s[0]=F=>I.value=!1),onClick:_,poster:n.posterImage},[m("source",{src:q(n.videoUrl),type:y.value},null,8,fe)],40,me),m("div",{class:oe(["video-controls",{"controls-visible":h.value}])},[m("div",pe,[m("div",{class:"progress-bar",style:le({width:`${S.value}%`})},null,4),Q(m("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=F=>S.value=F),onInput:B},null,544),[[X,S.value]])]),m("div",ge,[m("button",{class:"control-btn",onClick:K(_,["stop"])},[I.value?(c(),E(o,{key:1},{default:u(()=>s[4]||(s[4]=[i("mdi-pause")])),_:1})):(c(),E(o,{key:0},{default:u(()=>s[3]||(s[3]=[i("mdi-play")])),_:1}))]),m("div",_e,[m("button",{class:"control-btn",onClick:K(N,["stop"])},[p.value?(c(),E(o,{key:0},{default:u(()=>s[5]||(s[5]=[i("mdi-volume-off")])),_:1})):a.value<.5?(c(),E(o,{key:1},{default:u(()=>s[6]||(s[6]=[i("mdi-volume-low")])),_:1})):(c(),E(o,{key:2},{default:u(()=>s[7]||(s[7]=[i("mdi-volume-high")])),_:1}))]),Q(m("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=F=>a.value=F),onInput:M},null,544),[[X,a.value]])]),m("div",ye,C(z($.value))+" / "+C(z(U.value)),1),m("button",{class:"control-btn fullscreen-btn",onClick:K(j,["stop"])},[g.value?(c(),E(o,{key:0},{default:u(()=>s[8]||(s[8]=[i("mdi-fullscreen-exit")])),_:1})):(c(),E(o,{key:1},{default:u(()=>s[9]||(s[9]=[i("mdi-fullscreen")])),_:1}))])])],2),I.value?ae("",!0):(c(),k("div",{key:0,class:"big-play-button",onClick:K(_,["stop"])},[f(o,{size:"64"},{default:u(()=>s[10]||(s[10]=[i("mdi-play")])),_:1})]))],512)}}}),ke=ee(be,[["__scopeId","data-v-2135aa7c"]]),he={class:"page-wrapper"},we={key:0,class:"d-flex justify-center my-5"},Ie={key:1,class:"error-message"},Ue={key:2},xe={key:0,class:"breadcrumbs-container"},$e={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Le={class:"content-wrapper flex-column"},Se={class:"video-block mb-0 pt-0"},Te={class:"font-weight-medium mb-3"},Ce={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Pe=Z({__name:"LessonPage",setup(n){const{mdAndDown:x}=ne(),y=ue(),q=ie(),l=v(),r=v(""),I=v(""),$=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e};W(async()=>{const t=y.params.lessonId,e=localStorage.getItem(`lesson_image_${t}`);e&&(r.value=e,localStorage.removeItem(`lesson_image_${t}`)),await Promise.all([U(),D()]),!r.value&&g.value.imageUrl&&(r.value=$(g.value.imageUrl))});const U=async()=>{let e=0;for(;e<3;)try{a.value=!0;const s=await Y.getLessonDetails(d.value);return g.value=s,s}catch(s){if(e++,console.error(`Ошибка при загрузке урока (попытка ${e}/3):`,s),e>=3)throw p.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",s;await new Promise(o=>setTimeout(o,1e3*e))}finally{a.value=!1}},S=async t=>{if(t){a.value=!0,p.value="";try{const e=await de.fetchCourseWithBlocks(t);I.value=e.courseTitle||"Курс без названия",l.value=e.imageUrl}catch(e){console.error("Ошибка при загрузке курса:",e),p.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{a.value=!1}}};W(()=>{const t=y.params.courseId;t&&(h.value=t,S(t))});const a=v(!0),p=v(""),g=v({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),h=T(()=>y.params.courseId),w=T(()=>y.params.blocksId),d=T(()=>y.params.lessonId),_=v([]),L=T(()=>{const t=d.value?String(d.value):null;return _.value.findIndex(e=>{const s=e.id?String(e.id):null,o=e.lessonId?String(e.lessonId):null;return s===t||o===t})}),P=T(()=>{if(L.value>0){const t=_.value[L.value-1];return t.id||t.lessonId}return null}),B=T(()=>{if(L.value<_.value.length-1&&L.value!==-1){const t=_.value[L.value+1];return t.id||t.lessonId}return null}),M=v(!1),N=async()=>{if(!B.value){console.log("Нет следующего урока");return}if(B.value){const t=`/course/${h.value}/blocks/${w.value}/lessons/${B.value}`;q.push(t)}},j=T(()=>L.value!==-1&&L.value===_.value.length-1);V(()=>y.params.lessonId,(t,e)=>{M.value=!1,t&&t!==e&&(g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},a.value=!0,setTimeout(()=>{U()},100))},{immediate:!0}),V(_,()=>{},{immediate:!0}),V([()=>y.params.courseId,()=>y.params.blocksId],([t,e])=>{t&&e&&D()}),v(!1);const D=async()=>{try{const t=await Y.getLessonsByBlockId(w.value);_.value=t||[],d.value&&!M.value&&startLesson(d.value)}catch(t){console.error("Ошибка при загрузке списка уроков:",t),p.value="Не удалось загрузить список уроков. Пожалуйста, попробуйте позже."}};V(()=>y.params.lessonId,(t,e)=>{t&&t!==e&&(g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},a.value=!0,U())},{immediate:!0}),V(()=>y.params.lessonId,t=>{if(t){const e=localStorage.getItem(`lesson_image_${t}`);if(e)r.value=e,localStorage.removeItem(`lesson_image_${t}`);else{const s=_.value.find(o=>(o.id||o.lessonId)===t);s&&(s.imageUrl||s.lessonImage)?r.value=$(s.imageUrl||s.lessonImage):r.value=""}}},{immediate:!0});const z=()=>{if(!P.value){console.log("Нет предыдущего урока");return}const t=_.value.find(e=>(e.id||e.lessonId)===P.value);if(t&&(t.imageUrl||t.lessonImage)){const e=$(t.imageUrl||t.lessonImage);console.log("Сохраняем изображение предыдущего урока:",e),localStorage.setItem(`lesson_image_${P.value}`,e)}typeof J<"u"&&J.resetLessonState(d.value),q.push(`/course/${h.value}/blocks/${w.value}/lessons/${P.value}`)};return re(()=>{d.value&&J.resetLessonState(d.value)}),W(async()=>{try{a.value=!0,await S(h.value);const t=await U();if(await D(),t&&t.imageUrl)r.value=$(t.imageUrl);else{const e=localStorage.getItem(`lesson_image_${d.value}`);e?r.value=e:r.value="/public/default-lesson.jpg"}}catch(t){p.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",t)}finally{a.value=!1}}),V(()=>y.params.lessonId,async(t,e)=>{if(t&&t!==e){a.value=!0,p.value="",M.value=!1;try{g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""},await U()}catch{p.value="Не удалось загрузить урок. Попробуйте еще раз."}finally{a.value=!1}}},{immediate:!0}),(t,e)=>{const s=A("v-progress-circular"),o=A("v-breadcrumbs-item"),F=A("v-breadcrumbs"),G=A("v-btn"),O=A("v-icon"),te=A("v-container");return c(),k("div",he,[f(ve),f(te,{fluid:"",class:"content-container px-6 pt-2",width:R(x)?"100vw":"60vw"},{default:u(()=>[a.value?(c(),k("div",we,[f(s,{indeterminate:"",color:"#F48A21"})])):p.value?(c(),k("div",Ie,C(p.value),1)):(c(),k("div",Ue,[R(x)?(c(),k("div",$e,[f(G,{variant:"outlined",density:"comfortable",to:`/course/${h.value}/blocks/${w.value}`,class:"back-button text-none"},{default:u(()=>e[3]||(e[3]=[i(" К урокам ")])),_:1},8,["to"])])):(c(),k("div",xe,[f(F,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:u(()=>[f(o,{to:"/lk"},{default:u(()=>e[1]||(e[1]=[i("Профиль")])),_:1}),f(o,{to:`/course/${h.value}`},{default:u(()=>[i(C(I.value),1)]),_:1},8,["to"]),f(o,{to:`/course/${h.value}/blocks/${w.value}`},{default:u(()=>e[2]||(e[2]=[i("Уроки")])),_:1},8,["to"]),f(o,{disabled:""},{default:u(()=>[i(C(g.value.lessonTitle),1)]),_:1})]),_:1})])),m("div",Le,[m("div",Se,[m("h2",Te,C(g.value.lessonTitle),1),f(ke,{"video-url":g.value.videoUrl,"poster-image":$(r.value)},null,8,["video-url","poster-image"]),m("div",Ce,[f(G,{class:"text-none rounded-lg",width:R(x)?"40vw":"regular",variant:"outlined",onClick:z,disabled:!P.value},{default:u(()=>[R(x)?(c(),k(H,{key:0},[f(O,null,{default:u(()=>e[4]||(e[4]=[i("mdi-arrow-left")])),_:1}),e[5]||(e[5]=i(" Предыдущий "))],64)):(c(),k(H,{key:1},[i(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),f(G,{class:"text-none rounded-lg ml-4",width:R(x)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:e[0]||(e[0]=Ee=>N())},{default:u(()=>[R(x)?(c(),k(H,{key:0},[i(C(j.value?"Завершить":"Следующий")+" ",1),f(O,null,{default:u(()=>e[6]||(e[6]=[i("mdi-arrow-right")])),_:1})],64)):(c(),k(H,{key:1},[i(C(j.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])])])]))]),_:1},8,["width"]),f(ce)])}}}),Re=ee(Pe,[["__scopeId","data-v-9cacc672"]]);export{Re as default};
