import{d as Y,c as E,r as v,p as W,z as se,o as u,b as U,f as n,B as le,s as Q,C as X,k as z,i as T,w as c,g as f,t as M,n as oe,e as I,j as O,m as A,_ as Z,u as ae,x as H,D as ne,h as B,F as K,q as re,l as ue}from"./index-BJbwW3MX.js";import{H as ie,A as ve}from"./AppFooter-e2aZDmvd.js";import{c as G}from"./courseUserService-mhTRbRgA.js";const ce=["poster"],de=["src","type"],me={class:"video-progress"},fe={class:"controls-main"},pe={class:"volume-control"},ge={class:"time-display"},_e=Y({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(r){const C=r,b=E(()=>{if(!C.videoUrl)return"video/avi";switch(C.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),R=l=>{if(!l)return"/public/default-lesson.jpg";let s=l.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},o=v(null),a=v(null),L=v(!1),x=v(0),P=v(0),$=v(0),g=v(1),d=v(!1),p=v(!1),m=v(!0);let _=null;const y=()=>{m.value=!0,_&&clearTimeout(_),_=setTimeout(()=>{L.value&&(m.value=!1)},3e3)},h=()=>{o.value&&(L.value?o.value.pause():o.value.play(),L.value=!L.value,y())},k=()=>{o.value&&(x.value=o.value.currentTime,$.value=x.value/P.value*100)},S=()=>{o.value&&(P.value=o.value.duration)},D=()=>{if(!o.value)return;const l=$.value/100*P.value;o.value.currentTime=l},j=()=>{o.value&&(o.value.volume=g.value,d.value=g.value===0)},q=()=>{o.value&&(d.value?(d.value=!1,g.value=g.value===0?1:g.value,o.value.volume=g.value):(d.value=!0,o.value.volume=0))},F=()=>{a.value&&(document.fullscreenElement?(document.exitFullscreen(),p.value=!1):(a.value.requestFullscreen(),p.value=!0))},N=()=>{p.value=!!document.fullscreenElement},e=l=>{const s=Math.floor(l/60),i=Math.floor(l%60);return`${s}:${i<10?"0":""}${i}`},t=l=>{(document.activeElement===o.value||document.activeElement===a.value||p.value)&&(l.code==="Space"?(h(),l.preventDefault()):l.code==="ArrowRight"?(o.value&&(o.value.currentTime+=10),y()):l.code==="ArrowLeft"?(o.value&&(o.value.currentTime-=10),y()):l.code==="KeyM"?(q(),y()):l.code==="KeyF"&&(F(),y()))};return W(()=>{window.addEventListener("keydown",t),document.addEventListener("fullscreenchange",N),a.value&&a.value.addEventListener("mousemove",y),o.value&&(o.value.volume=g.value)}),se(()=>{window.removeEventListener("keydown",t),document.removeEventListener("fullscreenchange",N),a.value&&a.value.removeEventListener("mousemove",y),_&&clearTimeout(_)}),(l,s)=>{const i=A("v-icon");return u(),U("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:a},[n("video",{ref_key:"videoPlayer",ref:o,onTimeupdate:k,onLoadedmetadata:S,onEnded:s[0]||(s[0]=V=>L.value=!1),onClick:h,poster:r.posterImage},[n("source",{src:R(r.videoUrl),type:b.value},null,8,de)],40,ce),n("div",{class:oe(["video-controls",{"controls-visible":m.value}])},[n("div",me,[n("div",{class:"progress-bar",style:le({width:`${$.value}%`})},null,4),Q(n("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=V=>$.value=V),onInput:D},null,544),[[X,$.value]])]),n("div",fe,[n("button",{class:"control-btn",onClick:z(h,["stop"])},[L.value?(u(),T(i,{key:1},{default:c(()=>s[4]||(s[4]=[f("mdi-pause")])),_:1})):(u(),T(i,{key:0},{default:c(()=>s[3]||(s[3]=[f("mdi-play")])),_:1}))]),n("div",pe,[n("button",{class:"control-btn",onClick:z(q,["stop"])},[d.value?(u(),T(i,{key:0},{default:c(()=>s[5]||(s[5]=[f("mdi-volume-off")])),_:1})):g.value<.5?(u(),T(i,{key:1},{default:c(()=>s[6]||(s[6]=[f("mdi-volume-low")])),_:1})):(u(),T(i,{key:2},{default:c(()=>s[7]||(s[7]=[f("mdi-volume-high")])),_:1}))]),Q(n("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=V=>g.value=V),onInput:j},null,544),[[X,g.value]])]),n("div",ge,M(e(x.value))+" / "+M(e(P.value)),1),n("button",{class:"control-btn fullscreen-btn",onClick:z(F,["stop"])},[p.value?(u(),T(i,{key:0},{default:c(()=>s[8]||(s[8]=[f("mdi-fullscreen-exit")])),_:1})):(u(),T(i,{key:1},{default:c(()=>s[9]||(s[9]=[f("mdi-fullscreen")])),_:1}))])])],2),L.value?O("",!0):(u(),U("div",{key:0,class:"big-play-button",onClick:z(h,["stop"])},[I(i,{size:"64"},{default:c(()=>s[10]||(s[10]=[f("mdi-play")])),_:1})]))],512)}}}),ye=Z(_e,[["__scopeId","data-v-6075060f"]]),w={started:new Set,completed:new Set,inProgress:new Set},J={isLessonStarted(r){return w.started.has(r)},markLessonAsStarted(r){w.started.add(r)},isLessonCompleted(r){return w.completed.has(r)},markLessonAsCompleted(r){w.completed.add(r)},isRequestInProgress(r){return w.inProgress.has(r)},startRequest(r){w.inProgress.add(r)},finishRequest(r){w.inProgress.delete(r)},resetLessonState(r){w.started.delete(r),w.completed.delete(r)},resetAllStates(){w.started.clear(),w.completed.clear(),w.inProgress.clear()}},he={class:"page-wrapper"},ke={key:0,class:"d-flex justify-center my-5"},we={key:1,class:"error-message"},Ie={key:2},be={class:"back-button-container pt-4 pb-2 mt-5 pl-0 ml-0"},xe={class:"content-wrapper flex-column"},Ue={class:"video-block mb-0 pt-0"},Le={class:"font-weight-medium mb-3"},$e={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Se={class:"lesson-sidebar"},Te=["innerHTML"],Ce={class:"font-weight-light"},Pe=["href"],Ee=Y({__name:"LessonPage",setup(r){const{mdAndDown:C}=ae(),b=re(),R=ue(),o=v(),a=v(""),L=v(""),x=e=>{if(!e)return"/public/default-lesson.jpg";let t=e.replace(/https:\/\/https:\/\//g,"https://");return t=t.replace(/https:\/\/https\//g,"https://"),t};H(()=>b.params.lessonId,async(e,t)=>{if(e&&e!==t){d.value=!0;try{await P();const l=localStorage.getItem(`lesson_image_${e}`);if(l)a.value=l,localStorage.removeItem(`lesson_image_${e}`);else{const s=k.value.find(i=>(i.id||i.lessonId)===e);s&&(s.imageUrl||s.lessonImage)?a.value=x(s.imageUrl||s.lessonImage):m.value.imageUrl?a.value=x(m.value.imageUrl):a.value="/public/default-lesson.jpg"}}catch(l){console.error("Ошибка при обновлении урока:",l),p.value="Не удалось загрузить урок. Пожалуйста, обновите страницу."}finally{d.value=!1}}},{immediate:!0}),W(async()=>{const e=b.params.lessonId,t=localStorage.getItem(`lesson_image_${e}`);t&&(a.value=t,localStorage.removeItem(`lesson_image_${e}`)),await Promise.all([P(),$()]),!a.value&&m.value.imageUrl&&(a.value=x(m.value.imageUrl))});const P=async()=>{let t=0;for(;t<3;)try{d.value=!0;const l=await G.fetchLessonDetails(h.value);return m.value=l,l}catch(l){if(t++,console.error(`Ошибка при загрузке урока (попытка ${t}/3):`,l),t>=3)throw p.value="Не удалось загрузить урок. Пожалуйста, проверьте доступ к курсу и попробуйте снова.",l;await new Promise(s=>setTimeout(s,1e3*t))}finally{d.value=!1}},$=async()=>{try{const e=await G.fetchBlockWithLessons(y.value);k.value=e.lessons||[]}catch(e){console.error("Ошибка при загрузке списка уроков:",e),p.value="Не удалось загрузить список уроков. Пожалуйста, проверьте ваш доступ к курсу."}},g=async e=>{if(e){d.value=!0,p.value="";try{const t=await G.fetchCourseWithBlocks(e);L.value=t.courseTitle||"Курс без названия",o.value=t.imageUrl}catch(t){console.error("Ошибка при загрузке курса:",t),p.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{d.value=!1}}};W(()=>{const e=b.params.courseId;e&&(_.value=e,g(e))});const d=v(!0),p=v(""),m=v({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),_=E(()=>b.params.courseId),y=E(()=>b.params.blocksId),h=E(()=>b.params.lessonId),k=v([]),S=E(()=>{const e=h.value?String(h.value):null;return k.value.findIndex(t=>{const l=t.id?String(t.id):null,s=t.lessonId?String(t.lessonId):null;return l===e||s===e})}),D=E(()=>{if(S.value>0){const e=k.value[S.value-1];return e.id||e.lessonId}return null}),j=E(()=>{if(S.value<k.value.length-1&&S.value!==-1){const e=k.value[S.value+1];return e.id||e.lessonId}return null}),q=async()=>{if(F.value){R.push(`/course/${_.value}`);return}if(j.value){const e=`/course/${_.value}/blocks/${y.value}/lessons/${j.value}`;R.push(e)}},F=E(()=>S.value!==-1&&S.value===k.value.length-1);H(k,()=>{},{immediate:!0}),H([()=>b.params.courseId,()=>b.params.blocksId],([e,t])=>{e&&t&&$()}),H(()=>b.params.lessonId,e=>{if(e){const t=localStorage.getItem(`lesson_image_${e}`);if(t)a.value=t,localStorage.removeItem(`lesson_image_${e}`);else{const l=k.value.find(s=>(s.id||s.lessonId)===e);l&&(l.imageUrl||l.lessonImage)?a.value=x(l.imageUrl||l.lessonImage):a.value=""}}},{immediate:!0});const N=()=>{if(!D.value)return;const e=k.value.find(t=>(t.id||t.lessonId)===D.value);if(e&&(e.imageUrl||e.lessonImage)){const t=x(e.imageUrl||e.lessonImage);localStorage.setItem(`lesson_image_${D.value}`,t)}typeof J<"u"&&J.resetLessonState(h.value),R.push(`/course/${_.value}/blocks/${y.value}/lessons/${D.value}`)};return ne(()=>{h.value&&J.resetLessonState(h.value)}),W(async()=>{try{d.value=!0,await g(_.value);const e=await P();if(await $(),e&&e.imageUrl)a.value=x(e.imageUrl);else{const t=localStorage.getItem(`lesson_image_${h.value}`);t?a.value=t:a.value="/public/default-lesson.jpg"}}catch(e){p.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",e)}finally{d.value=!1}}),(e,t)=>{const l=A("v-progress-circular"),s=A("v-btn"),i=A("v-icon"),V=A("v-expansion-panel"),ee=A("v-expansion-panels"),te=A("v-container");return u(),U("div",he,[I(ie),I(te,{fluid:"",class:"content-container px-6 pt-2",width:B(C)?"100vw":"60vw"},{default:c(()=>[d.value?(u(),U("div",ke,[I(l,{indeterminate:"",color:"#F48A21"})])):p.value?(u(),U("div",we,M(p.value),1)):(u(),U("div",Ie,[n("div",be,[I(s,{variant:"outlined",density:"comfortable",to:`/course/${_.value}/blocks/${y.value}`,class:"back-button font-weight-light text-none"},{default:c(()=>t[1]||(t[1]=[f(" К урокам ")])),_:1},8,["to"])]),n("div",xe,[n("div",Ue,[n("h2",Le,M(m.value.lessonTitle),1),I(ye,{"video-url":m.value.videoUrl,"poster-image":x(a.value)},null,8,["video-url","poster-image"]),n("div",$e,[I(s,{class:"text-none rounded-lg",width:B(C)?"40vw":"regular",variant:"outlined",onClick:N,disabled:!D.value},{default:c(()=>[B(C)?(u(),U(K,{key:0},[I(i,null,{default:c(()=>t[2]||(t[2]=[f("mdi-arrow-left")])),_:1}),t[3]||(t[3]=f(" Предыдущий "))],64)):(u(),U(K,{key:1},[f(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),I(s,{class:"text-none rounded-lg ml-4",width:B(C)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:t[0]||(t[0]=De=>q())},{default:c(()=>[B(C)?(u(),U(K,{key:0},[f(M(F.value?"Завершить":"Следующий")+" ",1),I(i,null,{default:c(()=>t[4]||(t[4]=[f("mdi-arrow-right")])),_:1})],64)):(u(),U(K,{key:1},[f(M(F.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])]),n("div",Se,[I(ee,{class:"w-100"},{default:c(()=>[m.value.description?(u(),T(V,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:c(()=>[n("div",{class:"font-weight-light",innerHTML:m.value.description||"Описание отсутствует"},null,8,Te)]),_:1})):O("",!0),m.value.sheetUrl?(u(),T(V,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:c(()=>[n("p",Ce,[n("a",{href:m.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Pe)])]),_:1})):O("",!0)]),_:1})])])]))]),_:1},8,["width"]),I(ve)])}}}),Me=Z(Ee,[["__scopeId","data-v-0ee02616"]]);export{Me as default};
