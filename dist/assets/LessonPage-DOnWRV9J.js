import{d as Y,c as P,r as i,p as K,z as se,o as u,b as x,f as a,B as le,s as Q,C as X,k as z,i as T,w as c,g as v,t as M,n as oe,e as k,j as O,m as A,_ as Z,u as ae,x as W,D as ne,h as B,F as H,q as re,l as ue}from"./index-QKPnfKcf.js";import{H as ie,A as ce}from"./AppFooter-OZn1cCuk.js";import{c as G}from"./courseUserService-CTDqK2IW.js";const w={started:new Set,completed:new Set,inProgress:new Set},J={isLessonStarted(n){return w.started.has(n)},markLessonAsStarted(n){w.started.add(n)},isLessonCompleted(n){return w.completed.has(n)},markLessonAsCompleted(n){w.completed.add(n)},isRequestInProgress(n){return w.inProgress.has(n)},startRequest(n){w.inProgress.add(n)},finishRequest(n){w.inProgress.delete(n)},resetLessonState(n){w.started.delete(n),w.completed.delete(n)},resetAllStates(){w.started.clear(),w.completed.clear(),w.inProgress.clear()}},ve=["poster"],de=["src","type"],me={class:"video-progress"},pe={class:"controls-main"},fe={class:"volume-control"},ge={class:"time-display"},_e=Y({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(n){const C=n,b=P(()=>{if(!C.videoUrl)return"video/avi";switch(C.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),R=l=>{if(!l)return"/public/default-lesson.jpg";let s=l.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},o=i(null),r=i(null),L=i(!1),U=i(0),E=i(0),$=i(0),m=i(1),p=i(!1),f=i(!1),g=i(!0);let _=null;const y=()=>{g.value=!0,_&&clearTimeout(_),_=setTimeout(()=>{L.value&&(g.value=!1)},3e3)},h=()=>{o.value&&(L.value?o.value.pause():o.value.play(),L.value=!L.value,y())},I=()=>{o.value&&(U.value=o.value.currentTime,$.value=U.value/E.value*100)},S=()=>{o.value&&(E.value=o.value.duration)},D=()=>{if(!o.value)return;const l=$.value/100*E.value;o.value.currentTime=l},j=()=>{o.value&&(o.value.volume=m.value,p.value=m.value===0)},q=()=>{o.value&&(p.value?(p.value=!1,m.value=m.value===0?1:m.value,o.value.volume=m.value):(p.value=!0,o.value.volume=0))},F=()=>{r.value&&(document.fullscreenElement?(document.exitFullscreen(),f.value=!1):(r.value.requestFullscreen(),f.value=!0))},N=()=>{f.value=!!document.fullscreenElement},e=l=>{const s=Math.floor(l/60),d=Math.floor(l%60);return`${s}:${d<10?"0":""}${d}`},t=l=>{(document.activeElement===o.value||document.activeElement===r.value||f.value)&&(l.code==="Space"?(h(),l.preventDefault()):l.code==="ArrowRight"?(o.value&&(o.value.currentTime+=10),y()):l.code==="ArrowLeft"?(o.value&&(o.value.currentTime-=10),y()):l.code==="KeyM"?(q(),y()):l.code==="KeyF"&&(F(),y()))};return K(()=>{window.addEventListener("keydown",t),document.addEventListener("fullscreenchange",N),r.value&&r.value.addEventListener("mousemove",y),o.value&&(o.value.volume=m.value)}),se(()=>{window.removeEventListener("keydown",t),document.removeEventListener("fullscreenchange",N),r.value&&r.value.removeEventListener("mousemove",y),_&&clearTimeout(_)}),(l,s)=>{const d=A("v-icon");return u(),x("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:r},[a("video",{ref_key:"videoPlayer",ref:o,onTimeupdate:I,onLoadedmetadata:S,onEnded:s[0]||(s[0]=V=>L.value=!1),onClick:h,poster:n.posterImage},[a("source",{src:R(n.videoUrl),type:b.value},null,8,de)],40,ve),a("div",{class:oe(["video-controls",{"controls-visible":g.value}])},[a("div",me,[a("div",{class:"progress-bar",style:le({width:`${$.value}%`})},null,4),Q(a("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=V=>$.value=V),onInput:D},null,544),[[X,$.value]])]),a("div",pe,[a("button",{class:"control-btn",onClick:z(h,["stop"])},[L.value?(u(),T(d,{key:1},{default:c(()=>s[4]||(s[4]=[v("mdi-pause")])),_:1})):(u(),T(d,{key:0},{default:c(()=>s[3]||(s[3]=[v("mdi-play")])),_:1}))]),a("div",fe,[a("button",{class:"control-btn",onClick:z(q,["stop"])},[p.value?(u(),T(d,{key:0},{default:c(()=>s[5]||(s[5]=[v("mdi-volume-off")])),_:1})):m.value<.5?(u(),T(d,{key:1},{default:c(()=>s[6]||(s[6]=[v("mdi-volume-low")])),_:1})):(u(),T(d,{key:2},{default:c(()=>s[7]||(s[7]=[v("mdi-volume-high")])),_:1}))]),Q(a("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=V=>m.value=V),onInput:j},null,544),[[X,m.value]])]),a("div",ge,M(e(U.value))+" / "+M(e(E.value)),1),a("button",{class:"control-btn fullscreen-btn",onClick:z(F,["stop"])},[f.value?(u(),T(d,{key:0},{default:c(()=>s[8]||(s[8]=[v("mdi-fullscreen-exit")])),_:1})):(u(),T(d,{key:1},{default:c(()=>s[9]||(s[9]=[v("mdi-fullscreen")])),_:1}))])])],2),L.value?O("",!0):(u(),x("div",{key:0,class:"big-play-button",onClick:z(h,["stop"])},[k(d,{size:"64"},{default:c(()=>s[10]||(s[10]=[v("mdi-play")])),_:1})]))],512)}}}),ye=Z(_e,[["__scopeId","data-v-2135aa7c"]]),he={class:"page-wrapper"},we={key:0,class:"d-flex justify-center my-5"},ke={key:1,class:"error-message"},Ie={key:2},be={class:"back-button-container pt-4 pb-2 pl-0 ml-0"},xe={class:"content-wrapper flex-column"},Le={class:"video-block mb-0 pt-0"},Ue={class:"font-weight-medium mb-3"},$e={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Se={class:"lesson-sidebar"},Te=["innerHTML"],Ce={class:"font-weight-light"},Pe=["href"],Ee=Y({__name:"LessonPage",setup(n){const{mdAndDown:C}=ae(),b=re(),R=ue(),o=i(),r=i(""),L=i(""),U=e=>{if(!e)return"/public/default-lesson.jpg";let t=e.replace(/https:\/\/https:\/\//g,"https://");return t=t.replace(/https:\/\/https\//g,"https://"),t};K(async()=>{const e=b.params.lessonId,t=localStorage.getItem(`lesson_image_${e}`);t&&(r.value=t,localStorage.removeItem(`lesson_image_${e}`)),await Promise.all([E(),$()]),!r.value&&g.value.imageUrl&&(r.value=U(g.value.imageUrl))});const E=async()=>{let t=0;for(;t<3;)try{p.value=!0;const l=await G.fetchLessonDetails(h.value);return g.value=l,l}catch(l){if(t++,console.error(`Ошибка при загрузке урока (попытка ${t}/3):`,l),t>=3)throw f.value="Не удалось загрузить урок. Пожалуйста, проверьте доступ к курсу и попробуйте снова.",l;await new Promise(s=>setTimeout(s,1e3*t))}finally{p.value=!1}},$=async()=>{try{const e=await G.fetchBlockWithLessons(y.value);I.value=e.lessons||[]}catch(e){console.error("Ошибка при загрузке списка уроков:",e),f.value="Не удалось загрузить список уроков. Пожалуйста, проверьте ваш доступ к курсу."}},m=async e=>{if(e){p.value=!0,f.value="";try{const t=await G.fetchCourseWithBlocks(e);L.value=t.courseTitle||"Курс без названия",o.value=t.imageUrl}catch(t){console.error("Ошибка при загрузке курса:",t),f.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{p.value=!1}}};K(()=>{const e=b.params.courseId;e&&(_.value=e,m(e))});const p=i(!0),f=i(""),g=i({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),_=P(()=>b.params.courseId),y=P(()=>b.params.blocksId),h=P(()=>b.params.lessonId),I=i([]),S=P(()=>{const e=h.value?String(h.value):null;return I.value.findIndex(t=>{const l=t.id?String(t.id):null,s=t.lessonId?String(t.lessonId):null;return l===e||s===e})}),D=P(()=>{if(S.value>0){const e=I.value[S.value-1];return e.id||e.lessonId}return null}),j=P(()=>{if(S.value<I.value.length-1&&S.value!==-1){const e=I.value[S.value+1];return e.id||e.lessonId}return null});i(!1);const q=async()=>{if(F.value){R.push(`/course/${_.value}`);return}if(j.value){const e=`/course/${_.value}/blocks/${y.value}/lessons/${j.value}`;R.push(e)}},F=P(()=>S.value!==-1&&S.value===I.value.length-1);W(I,()=>{},{immediate:!0}),W([()=>b.params.courseId,()=>b.params.blocksId],([e,t])=>{e&&t&&$()}),W(()=>b.params.lessonId,e=>{if(e){const t=localStorage.getItem(`lesson_image_${e}`);if(t)r.value=t,localStorage.removeItem(`lesson_image_${e}`);else{const l=I.value.find(s=>(s.id||s.lessonId)===e);l&&(l.imageUrl||l.lessonImage)?r.value=U(l.imageUrl||l.lessonImage):r.value=""}}},{immediate:!0});const N=()=>{if(!D.value)return;const e=I.value.find(t=>(t.id||t.lessonId)===D.value);if(e&&(e.imageUrl||e.lessonImage)){const t=U(e.imageUrl||e.lessonImage);localStorage.setItem(`lesson_image_${D.value}`,t)}typeof J<"u"&&J.resetLessonState(h.value),R.push(`/course/${_.value}/blocks/${y.value}/lessons/${D.value}`)};return ne(()=>{h.value&&J.resetLessonState(h.value)}),K(async()=>{try{p.value=!0,await m(_.value);const e=await E();if(await $(),e&&e.imageUrl)r.value=U(e.imageUrl);else{const t=localStorage.getItem(`lesson_image_${h.value}`);t?r.value=t:r.value="/public/default-lesson.jpg"}}catch(e){f.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",e)}finally{p.value=!1}}),(e,t)=>{const l=A("v-progress-circular"),s=A("v-btn"),d=A("v-icon"),V=A("v-expansion-panel"),ee=A("v-expansion-panels"),te=A("v-container");return u(),x("div",he,[k(ie),k(te,{fluid:"",class:"content-container px-6 pt-2",width:B(C)?"100vw":"60vw"},{default:c(()=>[p.value?(u(),x("div",we,[k(l,{indeterminate:"",color:"#F48A21"})])):f.value?(u(),x("div",ke,M(f.value),1)):(u(),x("div",Ie,[a("div",be,[k(s,{variant:"outlined",density:"comfortable",to:`/course/${_.value}/blocks/${y.value}`,class:"back-button text-none"},{default:c(()=>t[1]||(t[1]=[v(" К урокам ")])),_:1},8,["to"])]),a("div",xe,[a("div",Le,[a("h2",Ue,M(g.value.lessonTitle),1),k(ye,{"video-url":g.value.videoUrl,"poster-image":U(r.value)},null,8,["video-url","poster-image"]),a("div",$e,[k(s,{class:"text-none rounded-lg",width:B(C)?"40vw":"regular",variant:"outlined",onClick:N,disabled:!D.value},{default:c(()=>[B(C)?(u(),x(H,{key:0},[k(d,null,{default:c(()=>t[2]||(t[2]=[v("mdi-arrow-left")])),_:1}),t[3]||(t[3]=v(" Предыдущий "))],64)):(u(),x(H,{key:1},[v(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),k(s,{class:"text-none rounded-lg ml-4",width:B(C)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:t[0]||(t[0]=De=>q())},{default:c(()=>[B(C)?(u(),x(H,{key:0},[v(M(F.value?"Завершить":"Следующий")+" ",1),k(d,null,{default:c(()=>t[4]||(t[4]=[v("mdi-arrow-right")])),_:1})],64)):(u(),x(H,{key:1},[v(M(F.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])]),a("div",Se,[k(ee,{class:"w-100"},{default:c(()=>[g.value.description?(u(),T(V,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:c(()=>[a("div",{class:"font-weight-light",innerHTML:g.value.description||"Описание отсутствует"},null,8,Te)]),_:1})):O("",!0),g.value.sheetUrl?(u(),T(V,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:c(()=>[a("p",Ce,[a("a",{href:g.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Pe)])]),_:1})):O("",!0)]),_:1})])])]))]),_:1},8,["width"]),k(ce)])}}}),Me=Z(Ee,[["__scopeId","data-v-da6e1120"]]);export{Me as default};
