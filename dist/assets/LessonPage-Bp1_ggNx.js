import{d as te,c as T,r as f,p as G,z as ne,o as a,b as _,f as r,B as re,s as X,C as Y,k as q,i as V,w as l,g as i,t as S,n as ue,e as m,j as ie,m as $,_ as se,u as ve,x as A,D as ce,L as F,h as R,F as K,q as de,l as me,E as fe,G as Z}from"./index-Qw8695L4.js";import{H as pe}from"./Header-Df4lH7Rn.js";import{c as ee}from"./courseService-zhMprMQU.js";import{c as ge}from"./courseUserService-BhW4jakx.js";const _e=["poster"],ye=["src","type"],he={class:"video-progress"},ke={class:"controls-main"},we={class:"volume-control"},be={class:"time-display"},Ie=te({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(N){const x=N,y=T(()=>{if(!x.videoUrl)return"video/avi";switch(x.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),j=d=>{if(!d)return"/public/default-lesson.jpg";let e=d.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e},s=f(null),w=f(null),h=f(!1),U=f(0),C=f(0),p=f(0),n=f(1),v=f(!1),g=f(!1),L=f(!0);let u=null;const c=()=>{L.value=!0,u&&clearTimeout(u),u=setTimeout(()=>{h.value&&(L.value=!1)},3e3)},k=()=>{s.value&&(h.value?s.value.pause():s.value.play(),h.value=!h.value,c())},P=()=>{s.value&&(U.value=s.value.currentTime,p.value=U.value/C.value*100)},E=()=>{s.value&&(C.value=s.value.duration)},D=()=>{if(!s.value)return;const d=p.value/100*C.value;s.value.currentTime=d},W=()=>{s.value&&(s.value.volume=n.value,v.value=n.value===0)},z=()=>{s.value&&(v.value?(v.value=!1,n.value=n.value===0?1:n.value,s.value.volume=n.value):(v.value=!0,s.value.volume=0))},M=()=>{w.value&&(document.fullscreenElement?(document.exitFullscreen(),g.value=!1):(w.value.requestFullscreen(),g.value=!0))},H=()=>{g.value=!!document.fullscreenElement},I=d=>{const e=Math.floor(d/60),t=Math.floor(d%60);return`${e}:${t<10?"0":""}${t}`},B=d=>{(document.activeElement===s.value||document.activeElement===w.value||g.value)&&(d.code==="Space"?(k(),d.preventDefault()):d.code==="ArrowRight"?(s.value&&(s.value.currentTime+=10),c()):d.code==="ArrowLeft"?(s.value&&(s.value.currentTime-=10),c()):d.code==="KeyM"?(z(),c()):d.code==="KeyF"&&(M(),c()))};return G(()=>{window.addEventListener("keydown",B),document.addEventListener("fullscreenchange",H),w.value&&w.value.addEventListener("mousemove",c),s.value&&(s.value.volume=n.value)}),ne(()=>{window.removeEventListener("keydown",B),document.removeEventListener("fullscreenchange",H),w.value&&w.value.removeEventListener("mousemove",c),u&&clearTimeout(u)}),(d,e)=>{const t=$("v-icon");return a(),_("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:w},[r("video",{ref_key:"videoPlayer",ref:s,onTimeupdate:P,onLoadedmetadata:E,onEnded:e[0]||(e[0]=o=>h.value=!1),onClick:k,poster:N.posterImage},[r("source",{src:j(N.videoUrl),type:y.value},null,8,ye)],40,_e),r("div",{class:ue(["video-controls",{"controls-visible":L.value}])},[r("div",he,[r("div",{class:"progress-bar",style:re({width:`${p.value}%`})},null,4),X(r("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":e[1]||(e[1]=o=>p.value=o),onInput:D},null,544),[[Y,p.value]])]),r("div",ke,[r("button",{class:"control-btn",onClick:q(k,["stop"])},[h.value?(a(),V(t,{key:1},{default:l(()=>e[4]||(e[4]=[i("mdi-pause")])),_:1})):(a(),V(t,{key:0},{default:l(()=>e[3]||(e[3]=[i("mdi-play")])),_:1}))]),r("div",we,[r("button",{class:"control-btn",onClick:q(z,["stop"])},[v.value?(a(),V(t,{key:0},{default:l(()=>e[5]||(e[5]=[i("mdi-volume-off")])),_:1})):n.value<.5?(a(),V(t,{key:1},{default:l(()=>e[6]||(e[6]=[i("mdi-volume-low")])),_:1})):(a(),V(t,{key:2},{default:l(()=>e[7]||(e[7]=[i("mdi-volume-high")])),_:1}))]),X(r("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":e[2]||(e[2]=o=>n.value=o),onInput:W},null,544),[[Y,n.value]])]),r("div",be,S(I(U.value))+" / "+S(I(C.value)),1),r("button",{class:"control-btn fullscreen-btn",onClick:q(M,["stop"])},[g.value?(a(),V(t,{key:0},{default:l(()=>e[8]||(e[8]=[i("mdi-fullscreen-exit")])),_:1})):(a(),V(t,{key:1},{default:l(()=>e[9]||(e[9]=[i("mdi-fullscreen")])),_:1}))])])],2),h.value?ie("",!0):(a(),_("div",{key:0,class:"big-play-button",onClick:q(k,["stop"])},[m(t,{size:"64"},{default:l(()=>e[10]||(e[10]=[i("mdi-play")])),_:1})]))],512)}}}),xe=se(Ie,[["__scopeId","data-v-2135aa7c"]]),Ue={class:"page-wrapper"},Le={key:0,class:"d-flex justify-center my-5"},$e={key:1,class:"error-message"},Te={key:2},Se={key:0,class:"breadcrumbs-container"},Ce={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Pe={class:"content-wrapper flex-column"},Ee={class:"video-block mb-0 pt-0"},De={class:"font-weight-medium mb-3"},Ve={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Fe={class:"lesson-sidebar"},Me=["innerHTML"],Be={key:0,class:"font-weight-light"},Ae=["href"],Re={key:1,class:"panel-text font-weight-light"},je=te({__name:"LessonPage",setup(N){const{mdAndDown:x}=ve(),y=de(),j=me(),s=f(""),w=f(""),h=e=>{if(!e)return"/public/default-lesson.jpg";let t=e.replace(/https:\/\/https:\/\//g,"https://");return t=t.replace(/https:\/\/https\//g,"https://"),t};G(async()=>{const e=y.params.lessonId,t=localStorage.getItem(`lesson_image_${e}`);t&&(s.value=t,localStorage.removeItem(`lesson_image_${e}`)),await Promise.all([U(),B()]),!s.value&&v.value.imageUrl&&(s.value=h(v.value.imageUrl))});const U=async()=>{let t=0;for(;t<3;)try{p.value=!0;const o=await ee.getLessonDetails(u.value);return v.value=o,o}catch(o){if(t++,console.error(`Ошибка при загрузке урока (попытка ${t}/3):`,o),t>=3)throw n.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",o;await new Promise(b=>setTimeout(b,1e3*t))}finally{p.value=!1}},C=async e=>{if(e){p.value=!0,n.value="";try{const t=await ge.fetchCourseWithBlocks(e);w.value=t.courseTitle||"Курс без названия"}catch(t){console.error("Ошибка при загрузке курса:",t),n.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{p.value=!1}}};G(()=>{const e=y.params.courseId;e&&(g.value=e,C(e))});const p=f(!0),n=f(""),v=f({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),g=T(()=>y.params.courseId),L=T(()=>y.params.blocksId),u=T(()=>y.params.lessonId),c=f([]),k=T(()=>{const e=u.value?String(u.value):null;return c.value.findIndex(t=>{const o=t.id?String(t.id):null,b=t.lessonId?String(t.lessonId):null;return o===e||b===e})}),P=T(()=>{if(k.value>0){const e=c.value[k.value-1];return e.id||e.lessonId}return null}),E=T(()=>{if(k.value<c.value.length-1&&k.value!==-1){const e=c.value[k.value+1];return e.id||e.lessonId}return null}),D=f(!1),W=async e=>{if(F.isLessonStarted(e)){D.value=!0;return}try{await fe(e),D.value=!0}catch(t){console.error("Ошибка при отметке начала урока:",t)}},z=async()=>{if(I.value){console.log("Переход уже выполняется, пропускаем");return}if(!E.value){console.log("Нет следующего урока");return}I.value=!0;try{const e=c.value.find(t=>(t.id||t.lessonId)===E.value);if(e&&(e.imageUrl||e.lessonImage)){const t=h(e.imageUrl||e.lessonImage);localStorage.setItem(`lesson_image_${E.value}`,t)}if(await Z(u.value),await new Promise(t=>setTimeout(t,300)),E.value){const t=`/course/${g.value}/blocks/${L.value}/lessons/${E.value}`;typeof F<"u"&&F.resetLessonState(u.value),j.push(t)}}catch(e){console.error("",e)}finally{setTimeout(()=>{I.value=!1},500)}},M=T(()=>k.value!==-1&&k.value===c.value.length-1),H=async()=>{if(!I.value){I.value=!0;try{await Z(u.value),await new Promise(e=>setTimeout(e,300)),F.resetLessonState(u.value),j.push(`/course/${g.value}`)}catch(e){console.error("Ошибка при завершении последнего урока:",e),alert("Произошла ошибка при завершении урока. Пожалуйста, попробуйте еще раз.")}finally{setTimeout(()=>{I.value=!1},500)}}};A(()=>y.params.lessonId,(e,t)=>{D.value=!1,e&&e!==t&&(v.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},p.value=!0,setTimeout(()=>{U()},100))},{immediate:!0}),A(c,()=>{},{immediate:!0}),A([()=>y.params.courseId,()=>y.params.blocksId],([e,t])=>{e&&t&&B()});const I=f(!1),B=async()=>{try{const e=await ee.getLessonsByBlockId(L.value);c.value=e||[],u.value&&!D.value&&W(u.value)}catch(e){console.error("Ошибка при загрузке списка уроков:",e),n.value="Не удалось загрузить список уроков. Пожалуйста, попробуйте позже."}};A(()=>y.params.lessonId,(e,t)=>{e&&e!==t&&(v.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},p.value=!0,U())},{immediate:!0}),A(()=>y.params.lessonId,e=>{if(e){const t=localStorage.getItem(`lesson_image_${e}`);if(t)s.value=t,localStorage.removeItem(`lesson_image_${e}`);else{const o=c.value.find(b=>(b.id||b.lessonId)===e);o&&(o.imageUrl||o.lessonImage)?s.value=h(o.imageUrl||o.lessonImage):s.value=""}}},{immediate:!0});const d=()=>{if(!P.value){console.log("Нет предыдущего урока");return}const e=c.value.find(t=>(t.id||t.lessonId)===P.value);if(e&&(e.imageUrl||e.lessonImage)){const t=h(e.imageUrl||e.lessonImage);console.log("Сохраняем изображение предыдущего урока:",t),localStorage.setItem(`lesson_image_${P.value}`,t)}typeof F<"u"&&F.resetLessonState(u.value),j.push(`/course/${g.value}/blocks/${L.value}/lessons/${P.value}`)};return ce(()=>{u.value&&F.resetLessonState(u.value)}),G(async()=>{try{p.value=!0,await C(g.value);const e=await U();if(await B(),e&&e.imageUrl)s.value=h(e.imageUrl);else{const t=localStorage.getItem(`lesson_image_${u.value}`);t?s.value=t:s.value="/public/default-lesson.jpg"}}catch(e){n.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",e)}finally{p.value=!1}}),A(()=>y.params.lessonId,async(e,t)=>{if(e&&e!==t){p.value=!0,n.value="",D.value=!1;try{v.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""},await U()}catch{n.value="Не удалось загрузить урок. Попробуйте еще раз."}finally{p.value=!1}}},{immediate:!0}),(e,t)=>{const o=$("v-progress-circular"),b=$("v-breadcrumbs-item"),le=$("v-breadcrumbs"),J=$("v-btn"),O=$("v-icon"),Q=$("v-expansion-panel"),oe=$("v-expansion-panels"),ae=$("v-container");return a(),_("div",Ue,[m(pe),m(ae,{fluid:"",class:"content-container px-6 pt-2",width:R(x)?"100vw":"80vw"},{default:l(()=>[p.value?(a(),_("div",Le,[m(o,{indeterminate:"",color:"#F48A21"})])):n.value?(a(),_("div",$e,S(n.value),1)):(a(),_("div",Te,[R(x)?(a(),_("div",Ce,[m(J,{variant:"outlined",density:"comfortable",to:`/course/${g.value}/blocks/${L.value}`,class:"back-button text-none"},{default:l(()=>t[3]||(t[3]=[i(" К урокам ")])),_:1},8,["to"])])):(a(),_("div",Se,[m(le,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:l(()=>[m(b,{to:"/lk"},{default:l(()=>t[1]||(t[1]=[i("Профиль")])),_:1}),m(b,{to:`/course/${g.value}`},{default:l(()=>[i(S(w.value),1)]),_:1},8,["to"]),m(b,{to:`/course/${g.value}/blocks/${L.value}`},{default:l(()=>t[2]||(t[2]=[i("Уроки")])),_:1},8,["to"]),m(b,{disabled:""},{default:l(()=>[i(S(v.value.lessonTitle),1)]),_:1})]),_:1})])),r("div",Pe,[r("div",Ee,[r("h2",De,S(v.value.lessonTitle),1),m(xe,{"video-url":v.value.videoUrl,"poster-image":s.value},null,8,["video-url","poster-image"]),r("div",Ve,[m(J,{class:"text-none rounded-lg",width:R(x)?"40vw":"regular",variant:"outlined",onClick:d,disabled:!P.value},{default:l(()=>[R(x)?(a(),_(K,{key:0},[m(O,null,{default:l(()=>t[4]||(t[4]=[i("mdi-arrow-left")])),_:1}),t[5]||(t[5]=i(" Предыдущий "))],64)):(a(),_(K,{key:1},[i(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),m(J,{class:"text-none rounded-lg ml-4",width:R(x)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:t[0]||(t[0]=Ne=>M.value?H():z()),loading:I.value},{default:l(()=>[R(x)?(a(),_(K,{key:0},[i(S(M.value?"Завершить":"Следующий")+" ",1),m(O,null,{default:l(()=>t[6]||(t[6]=[i("mdi-arrow-right")])),_:1})],64)):(a(),_(K,{key:1},[i(S(M.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width","loading"])])]),r("div",Fe,[m(oe,{class:"w-100"},{default:l(()=>[m(Q,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:l(()=>[r("div",{class:"font-weight-light",innerHTML:v.value.description||"Описание отсутствует"},null,8,Me)]),_:1}),m(Q,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:l(()=>[v.value.sheetUrl?(a(),_("p",Be,[r("a",{href:v.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Ae)])):(a(),_("p",Re,"У данного урока нет материалов"))]),_:1})]),_:1})])])]))]),_:1},8,["width"])])}}}),Ge=se(je,[["__scopeId","data-v-b9a2373a"]]);export{Ge as default};
