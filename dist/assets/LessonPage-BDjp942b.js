import{d as ee,b as T,r as v,p as K,z as ae,o as n,c as y,f as r,B as ne,s as Q,C as X,k as H,i as P,w as a,g as u,t as S,n as re,e as i,j as ue,m as L,_ as te,u as ie,x as D,D as ve,L as F,h as M,F as q,q as ce,l as de,E as Y}from"./index-DaAjR9Ux.js";import{H as me}from"./Header-BlLWUaW7.js";import{c as Z}from"./courseService-C7QO0mZp.js";import{c as fe}from"./courseUserService-DiAsgWMV.js";const pe=["poster"],ge=["src","type"],_e={class:"video-progress"},ye={class:"controls-main"},he={class:"volume-control"},ke={class:"time-display"},we=ee({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(R){const U=R,h=T(()=>{if(!U.videoUrl)return"video/avi";switch(U.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),B=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e},s=v(null),w=v(null),k=v(!1),E=v(0),c=v(0),g=v(0),o=v(1),_=v(!1),b=v(!1),f=v(!0);let d=null;const p=()=>{f.value=!0,d&&clearTimeout(d),d=setTimeout(()=>{k.value&&(f.value=!1)},3e3)},I=()=>{s.value&&(k.value?s.value.pause():s.value.play(),k.value=!k.value,p())},C=()=>{s.value&&(E.value=s.value.currentTime,g.value=E.value/c.value*100)},j=()=>{s.value&&(c.value=s.value.duration)},W=()=>{if(!s.value)return;const t=g.value/100*c.value;s.value.currentTime=t},A=()=>{s.value&&(s.value.volume=o.value,_.value=o.value===0)},N=()=>{s.value&&(_.value?(_.value=!1,o.value=o.value===0?1:o.value,s.value.volume=o.value):(_.value=!0,s.value.volume=0))},x=()=>{w.value&&(document.fullscreenElement?(document.exitFullscreen(),b.value=!1):(w.value.requestFullscreen(),b.value=!0))},$=()=>{b.value=!!document.fullscreenElement},V=t=>{const e=Math.floor(t/60),l=Math.floor(t%60);return`${e}:${l<10?"0":""}${l}`},z=t=>{(document.activeElement===s.value||document.activeElement===w.value||b.value)&&(t.code==="Space"?(I(),t.preventDefault()):t.code==="ArrowRight"?(s.value&&(s.value.currentTime+=10),p()):t.code==="ArrowLeft"?(s.value&&(s.value.currentTime-=10),p()):t.code==="KeyM"?(N(),p()):t.code==="KeyF"&&(x(),p()))};return K(()=>{window.addEventListener("keydown",z),document.addEventListener("fullscreenchange",$),w.value&&w.value.addEventListener("mousemove",p),s.value&&(s.value.volume=o.value)}),ae(()=>{window.removeEventListener("keydown",z),document.removeEventListener("fullscreenchange",$),w.value&&w.value.removeEventListener("mousemove",p),d&&clearTimeout(d)}),(t,e)=>{const l=L("v-icon");return n(),y("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:w},[r("video",{ref_key:"videoPlayer",ref:s,onTimeupdate:C,onLoadedmetadata:j,onEnded:e[0]||(e[0]=m=>k.value=!1),onClick:I,poster:R.posterImage},[r("source",{src:B(R.videoUrl),type:h.value},null,8,ge)],40,pe),r("div",{class:re(["video-controls",{"controls-visible":f.value}])},[r("div",_e,[r("div",{class:"progress-bar",style:ne({width:`${g.value}%`})},null,4),Q(r("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":e[1]||(e[1]=m=>g.value=m),onInput:W},null,544),[[X,g.value]])]),r("div",ye,[r("button",{class:"control-btn",onClick:H(I,["stop"])},[k.value?(n(),P(l,{key:1},{default:a(()=>e[4]||(e[4]=[u("mdi-pause")])),_:1})):(n(),P(l,{key:0},{default:a(()=>e[3]||(e[3]=[u("mdi-play")])),_:1}))]),r("div",he,[r("button",{class:"control-btn",onClick:H(N,["stop"])},[_.value?(n(),P(l,{key:0},{default:a(()=>e[5]||(e[5]=[u("mdi-volume-off")])),_:1})):o.value<.5?(n(),P(l,{key:1},{default:a(()=>e[6]||(e[6]=[u("mdi-volume-low")])),_:1})):(n(),P(l,{key:2},{default:a(()=>e[7]||(e[7]=[u("mdi-volume-high")])),_:1}))]),Q(r("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":e[2]||(e[2]=m=>o.value=m),onInput:A},null,544),[[X,o.value]])]),r("div",ke,S(V(E.value))+" / "+S(V(c.value)),1),r("button",{class:"control-btn fullscreen-btn",onClick:H(x,["stop"])},[b.value?(n(),P(l,{key:0},{default:a(()=>e[8]||(e[8]=[u("mdi-fullscreen-exit")])),_:1})):(n(),P(l,{key:1},{default:a(()=>e[9]||(e[9]=[u("mdi-fullscreen")])),_:1}))])])],2),k.value?ue("",!0):(n(),y("div",{key:0,class:"big-play-button",onClick:H(I,["stop"])},[i(l,{size:"64"},{default:a(()=>e[10]||(e[10]=[u("mdi-play")])),_:1})]))],512)}}}),be=te(we,[["__scopeId","data-v-2135aa7c"]]),Ie={class:"page-wrapper"},xe={key:0,class:"d-flex justify-center my-5"},Ue={key:1,class:"error-message"},Le={key:2},$e={key:0,class:"breadcrumbs-container"},Te={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Se={class:"content-wrapper flex-column"},Ce={class:"video-block mb-0 pt-0"},Pe={class:"font-weight-medium mb-3"},Ee={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Ve={class:"lesson-sidebar"},De=["innerHTML"],Fe={key:0,class:"font-weight-light"},Me=["href"],Be={key:1,class:"panel-text font-weight-light"},Ae=ee({__name:"LessonPage",setup(R){const{mdAndDown:U}=ie(),h=ce(),B=de(),s=v(""),w=v(""),k=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e};K(async()=>{const t=h.params.lessonId,e=localStorage.getItem(`lesson_image_${t}`);e&&(s.value=e,localStorage.removeItem(`lesson_image_${t}`)),await Promise.all([$(),V()]),!s.value&&o.value.imageUrl&&(s.value=k(o.value.imageUrl))});const E=async t=>{if(t){c.value=!0,g.value="";try{const e=await fe.fetchCourseWithBlocks(t);w.value=e.courseTitle||"Курс без названия"}catch(e){console.error("Ошибка при загрузке курса:",e),g.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{c.value=!1}}};K(()=>{const t=h.params.courseId;t&&(_.value=t,E(t))});const c=v(!0),g=v(""),o=v({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),_=T(()=>h.params.courseId),b=T(()=>h.params.blocksId),f=T(()=>h.params.lessonId),d=v([]),p=T(()=>{const t=f.value?String(f.value):null;return d.value.findIndex(e=>{const l=e.id?String(e.id):null,m=e.lessonId?String(e.lessonId):null;return l===t||m===t})}),I=T(()=>{if(p.value>0){const t=d.value[p.value-1];return t.id||t.lessonId}return null}),C=T(()=>{if(p.value<d.value.length-1&&p.value!==-1){const t=d.value[p.value+1];return t.id||t.lessonId}return null}),j=v(!1),W=async()=>{if(x.value){console.log("Переход уже выполняется, пропускаем");return}if(!C.value){console.log("Нет следующего урока");return}x.value=!0;try{const t=d.value.find(e=>(e.id||e.lessonId)===C.value);if(t&&(t.imageUrl||t.lessonImage)){const e=k(t.imageUrl||t.lessonImage);localStorage.setItem(`lesson_image_${C.value}`,e)}if(await Y(f.value),await new Promise(e=>setTimeout(e,300)),C.value){const e=`/course/${_.value}/blocks/${b.value}/lessons/${C.value}`;typeof F<"u"&&F.resetLessonState(f.value),B.push(e)}}catch(t){console.error("",t)}finally{setTimeout(()=>{x.value=!1},500)}},A=T(()=>p.value!==-1&&p.value===d.value.length-1),N=async()=>{if(!x.value){x.value=!0;try{await Y(f.value),await new Promise(t=>setTimeout(t,300)),F.resetLessonState(f.value),B.push(`/course/${_.value}`)}catch(t){console.error("Ошибка при завершении последнего урока:",t),alert("Произошла ошибка при завершении урока. Пожалуйста, попробуйте еще раз.")}finally{setTimeout(()=>{x.value=!1},500)}}};D(()=>h.params.lessonId,(t,e)=>{j.value=!1,t&&t!==e&&(o.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},c.value=!0,setTimeout(()=>{$()},100))},{immediate:!0}),D(d,()=>{},{immediate:!0}),D([()=>h.params.courseId,()=>h.params.blocksId],([t,e])=>{t&&e&&V()});const x=v(!1),$=async()=>{let e=0;for(;e<3;)try{c.value=!0;const l=await Z.fetchLesson(f.value);return o.value=l,l}catch(l){if(e++,console.error(`Ошибка при загрузке урока (попытка ${e}/3):`,l),e>=3)throw g.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",l;await new Promise(m=>setTimeout(m,1e3*e))}finally{c.value=!1}};D(()=>h.params.lessonId,(t,e)=>{t&&t!==e&&(o.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},c.value=!0,$())},{immediate:!0}),D(()=>h.params.lessonId,t=>{if(t){const e=localStorage.getItem(`lesson_image_${t}`);if(e)s.value=e,localStorage.removeItem(`lesson_image_${t}`);else{const l=d.value.find(m=>(m.id||m.lessonId)===t);l&&(l.imageUrl||l.lessonImage)?s.value=k(l.imageUrl||l.lessonImage):s.value=""}}},{immediate:!0});const V=async()=>{try{const t=await Z.getLessonsByBlockId(b.value);d.value=t}catch(t){console.error("Ошибка при загрузке списка уроков:",t)}},z=()=>{if(!I.value){console.log("Нет предыдущего урока");return}const t=d.value.find(e=>(e.id||e.lessonId)===I.value);if(t&&(t.imageUrl||t.lessonImage)){const e=k(t.imageUrl||t.lessonImage);console.log("Сохраняем изображение предыдущего урока:",e),localStorage.setItem(`lesson_image_${I.value}`,e)}typeof F<"u"&&F.resetLessonState(f.value),B.push(`/course/${_.value}/blocks/${b.value}/lessons/${I.value}`)};return ve(()=>{f.value&&F.resetLessonState(f.value)}),K(async()=>{try{c.value=!0,await E(_.value);const t=await $();if(await V(),t&&t.imageUrl)s.value=k(t.imageUrl);else{const e=localStorage.getItem(`lesson_image_${f.value}`);e?s.value=e:s.value="/public/default-lesson.jpg"}}catch(t){g.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",t)}finally{c.value=!1}}),D(()=>h.params.lessonId,async(t,e)=>{if(t&&t!==e){c.value=!0,g.value="",j.value=!1;try{o.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""},await $()}catch{g.value="Не удалось загрузить урок. Попробуйте еще раз."}finally{c.value=!1}}},{immediate:!0}),(t,e)=>{const l=L("v-progress-circular"),m=L("v-breadcrumbs-item"),se=L("v-breadcrumbs"),G=L("v-btn"),J=L("v-icon"),O=L("v-expansion-panel"),le=L("v-expansion-panels"),oe=L("v-container");return n(),y("div",Ie,[i(me),i(oe,{fluid:"",class:"content-container px-6 pt-2",width:M(U)?"100vw":"80vw"},{default:a(()=>[c.value?(n(),y("div",xe,[i(l,{indeterminate:"",color:"#F48A21"})])):g.value?(n(),y("div",Ue,S(g.value),1)):(n(),y("div",Le,[M(U)?(n(),y("div",Te,[i(G,{variant:"outlined",density:"comfortable",to:`/course/${_.value}/blocks/${b.value}`,class:"back-button text-none"},{default:a(()=>e[3]||(e[3]=[u(" К урокам ")])),_:1},8,["to"])])):(n(),y("div",$e,[i(se,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:a(()=>[i(m,{to:"/lk"},{default:a(()=>e[1]||(e[1]=[u("Профиль")])),_:1}),i(m,{to:`/course/${_.value}`},{default:a(()=>[u(S(w.value),1)]),_:1},8,["to"]),i(m,{to:`/course/${_.value}/blocks/${b.value}`},{default:a(()=>e[2]||(e[2]=[u("Уроки")])),_:1},8,["to"]),i(m,{disabled:""},{default:a(()=>[u(S(o.value.lessonTitle),1)]),_:1})]),_:1})])),r("div",Se,[r("div",Ce,[r("h2",Pe,S(o.value.lessonTitle),1),i(be,{"video-url":o.value.videoUrl,"poster-image":s.value},null,8,["video-url","poster-image"]),r("div",Ee,[i(G,{class:"text-none rounded-lg",width:M(U)?"40vw":"regular",variant:"outlined",onClick:z,disabled:!I.value},{default:a(()=>[M(U)?(n(),y(q,{key:0},[i(J,null,{default:a(()=>e[4]||(e[4]=[u("mdi-arrow-left")])),_:1}),e[5]||(e[5]=u(" Предыдущий "))],64)):(n(),y(q,{key:1},[u(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),i(G,{class:"text-none rounded-lg ml-4",width:M(U)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:e[0]||(e[0]=Re=>A.value?N():W()),loading:x.value},{default:a(()=>[M(U)?(n(),y(q,{key:0},[u(S(A.value?"Завершить":"Следующий")+" ",1),i(J,null,{default:a(()=>e[6]||(e[6]=[u("mdi-arrow-right")])),_:1})],64)):(n(),y(q,{key:1},[u(S(A.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width","loading"])])]),r("div",Ve,[i(le,{class:"w-100"},{default:a(()=>[i(O,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:a(()=>[r("div",{class:"font-weight-light",innerHTML:o.value.description||"Описание отсутствует"},null,8,De)]),_:1}),i(O,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:a(()=>[o.value.sheetUrl?(n(),y("p",Fe,[r("a",{href:o.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Me)])):(n(),y("p",Be," У данного урока нет материалов "))]),_:1})]),_:1})])])]))]),_:1},8,["width"])])}}}),qe=te(Ae,[["__scopeId","data-v-ee81d809"]]);export{qe as default};
