import{d as Y,h as E,g as c,i as G,j as se,o as u,c as U,b as n,n as le,B as Q,E as X,y as z,s as T,w as v,e as p,t as F,p as oe,a as I,v as O,r as V,_ as Z,u as ae,D as K,G as ne,f as M,F as W,z as re,m as ue}from"./index-r6CkWk_M.js";import{A as ie}from"./Header-Cn-_yNmi.js";import{c as H}from"./courseUserService-D92D7Kjw.js";import{A as ce}from"./AppFooter-7TrP2N6X.js";const ve=["poster"],de=["src","type"],me={class:"video-progress"},fe={class:"controls-main"},pe={class:"volume-control"},ge={class:"time-display"},_e=Y({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(r){const C=r,b=E(()=>{if(!C.videoUrl)return"video/avi";switch(C.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),B=l=>{if(!l)return"/public/default-lesson.jpg";let s=l.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},o=c(null),a=c(null),$=c(!1),x=c(0),P=c(0),S=c(0),g=c(1),d=c(!1),f=c(!1),m=c(!0);let _=null;const y=()=>{m.value=!0,_&&clearTimeout(_),_=setTimeout(()=>{$.value&&(m.value=!1)},3e3)},h=()=>{o.value&&($.value?o.value.pause():o.value.play(),$.value=!$.value,y())},w=()=>{o.value&&(x.value=o.value.currentTime,S.value=x.value/P.value*100)},L=()=>{o.value&&(P.value=o.value.duration)},A=()=>{if(!o.value)return;const l=S.value/100*P.value;o.value.currentTime=l},j=()=>{o.value&&(o.value.volume=g.value,d.value=g.value===0)},q=()=>{o.value&&(d.value?(d.value=!1,g.value=g.value===0?1:g.value,o.value.volume=g.value):(d.value=!0,o.value.volume=0))},R=()=>{a.value&&(document.fullscreenElement?(document.exitFullscreen(),f.value=!1):(a.value.requestFullscreen(),f.value=!0))},N=()=>{f.value=!!document.fullscreenElement},e=l=>{const s=Math.floor(l/60),i=Math.floor(l%60);return`${s}:${i<10?"0":""}${i}`},t=l=>{(document.activeElement===o.value||document.activeElement===a.value||f.value)&&(l.code==="Space"?(h(),l.preventDefault()):l.code==="ArrowRight"?(o.value&&(o.value.currentTime+=10),y()):l.code==="ArrowLeft"?(o.value&&(o.value.currentTime-=10),y()):l.code==="KeyM"?(q(),y()):l.code==="KeyF"&&(R(),y()))};return G(()=>{window.addEventListener("keydown",t),document.addEventListener("fullscreenchange",N),a.value&&a.value.addEventListener("mousemove",y),o.value&&(o.value.volume=g.value)}),se(()=>{window.removeEventListener("keydown",t),document.removeEventListener("fullscreenchange",N),a.value&&a.value.removeEventListener("mousemove",y),_&&clearTimeout(_)}),(l,s)=>{const i=V("v-icon");return u(),U("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:a},[n("video",{ref_key:"videoPlayer",ref:o,onTimeupdate:w,onLoadedmetadata:L,onEnded:s[0]||(s[0]=D=>$.value=!1),onClick:h,poster:r.posterImage},[n("source",{src:B(r.videoUrl),type:b.value},null,8,de)],40,ve),n("div",{class:oe(["video-controls",{"controls-visible":m.value}])},[n("div",me,[n("div",{class:"progress-bar",style:le({width:`${S.value}%`})},null,4),Q(n("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=D=>S.value=D),onInput:A},null,544),[[X,S.value]])]),n("div",fe,[n("button",{class:"control-btn",onClick:z(h,["stop"])},[$.value?(u(),T(i,{key:1},{default:v(()=>s[4]||(s[4]=[p("mdi-pause")])),_:1})):(u(),T(i,{key:0},{default:v(()=>s[3]||(s[3]=[p("mdi-play")])),_:1}))]),n("div",pe,[n("button",{class:"control-btn",onClick:z(q,["stop"])},[d.value?(u(),T(i,{key:0},{default:v(()=>s[5]||(s[5]=[p("mdi-volume-off")])),_:1})):g.value<.5?(u(),T(i,{key:1},{default:v(()=>s[6]||(s[6]=[p("mdi-volume-low")])),_:1})):(u(),T(i,{key:2},{default:v(()=>s[7]||(s[7]=[p("mdi-volume-high")])),_:1}))]),Q(n("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=D=>g.value=D),onInput:j},null,544),[[X,g.value]])]),n("div",ge,F(e(x.value))+" / "+F(e(P.value)),1),n("button",{class:"control-btn fullscreen-btn",onClick:z(R,["stop"])},[f.value?(u(),T(i,{key:0},{default:v(()=>s[8]||(s[8]=[p("mdi-fullscreen-exit")])),_:1})):(u(),T(i,{key:1},{default:v(()=>s[9]||(s[9]=[p("mdi-fullscreen")])),_:1}))])])],2),$.value?O("",!0):(u(),U("div",{key:0,class:"big-play-button",onClick:z(h,["stop"])},[I(i,{size:"64"},{default:v(()=>s[10]||(s[10]=[p("mdi-play")])),_:1})]))],512)}}}),ye=Z(_e,[["__scopeId","data-v-37d4fb5c"]]),k={started:new Set,completed:new Set,inProgress:new Set},J={isLessonStarted(r){return k.started.has(r)},markLessonAsStarted(r){k.started.add(r)},isLessonCompleted(r){return k.completed.has(r)},markLessonAsCompleted(r){k.completed.add(r)},isRequestInProgress(r){return k.inProgress.has(r)},startRequest(r){k.inProgress.add(r)},finishRequest(r){k.inProgress.delete(r)},resetLessonState(r){k.started.delete(r),k.completed.delete(r)},resetAllStates(){k.started.clear(),k.completed.clear(),k.inProgress.clear()}},he={class:"page-wrapper"},we={key:0,class:"d-flex justify-center my-5"},ke={key:1,class:"error-message"},Ie={key:2},be={class:"back-button-container ga-3 mt-8 mb-3"},xe={class:"content-wrapper flex-column"},Ue={class:"video-block mb-0 pt-0"},$e={class:"font-weight-medium mb-3"},Se={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Le={class:"lesson-sidebar"},Te={class:"font-weight-light"},Ce={class:"font-weight-light"},Pe=["href"],Ee=Y({__name:"LessonPage",setup(r){const{mdAndDown:C}=ae(),b=re(),B=ue(),o=c(),a=c(""),$=c(""),x=e=>{if(!e)return"/public/default-lesson.jpg";let t=e.replace(/https:\/\/https:\/\//g,"https://");return t=t.replace(/https:\/\/https\//g,"https://"),t};K(()=>b.params.lessonId,async(e,t)=>{if(e&&e!==t){d.value=!0;try{await P();const l=localStorage.getItem(`lesson_image_${e}`);if(l)a.value=l,localStorage.removeItem(`lesson_image_${e}`);else{const s=w.value.find(i=>(i.id||i.lessonId)===e);s&&(s.imageUrl||s.lessonImage)?a.value=x(s.imageUrl||s.lessonImage):m.value.imageUrl?a.value=x(m.value.imageUrl):a.value="/public/default-lesson.jpg"}}catch(l){console.error("Ошибка при обновлении урока:",l),f.value="Не удалось загрузить урок. Пожалуйста, обновите страницу."}finally{d.value=!1}}},{immediate:!0}),G(async()=>{const e=b.params.lessonId,t=localStorage.getItem(`lesson_image_${e}`);t&&(a.value=t,localStorage.removeItem(`lesson_image_${e}`)),await Promise.all([P(),S()]),!a.value&&m.value.imageUrl&&(a.value=x(m.value.imageUrl))});const P=async()=>{let t=0;for(;t<3;)try{d.value=!0;const l=await H.fetchLessonDetails(h.value);return m.value=l,l}catch(l){if(t++,console.error(`Ошибка при загрузке урока (попытка ${t}/3):`,l),t>=3)throw f.value="Не удалось загрузить урок. Пожалуйста, проверьте доступ к курсу и попробуйте снова.",l;await new Promise(s=>setTimeout(s,1e3*t))}finally{d.value=!1}},S=async()=>{try{const e=await H.fetchBlockWithLessons(y.value);w.value=e.lessons||[]}catch(e){console.error("Ошибка при загрузке списка уроков:",e),f.value="Не удалось загрузить список уроков. Пожалуйста, проверьте ваш доступ к курсу."}},g=async e=>{if(e){d.value=!0,f.value="";try{const t=await H.fetchCourseWithBlocks(e);$.value=t.courseTitle||"Курс без названия",o.value=t.imageUrl}catch(t){console.error("Ошибка при загрузке курса:",t),f.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{d.value=!1}}};G(()=>{const e=b.params.courseId;e&&(_.value=e,g(e))});const d=c(!0),f=c(""),m=c({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),_=E(()=>b.params.courseId),y=E(()=>b.params.blocksId),h=E(()=>b.params.lessonId),w=c([]),L=E(()=>{const e=h.value?String(h.value):null;return w.value.findIndex(t=>{const l=t.id?String(t.id):null,s=t.lessonId?String(t.lessonId):null;return l===e||s===e})}),A=E(()=>{if(L.value>0){const e=w.value[L.value-1];return e.id||e.lessonId}return null}),j=E(()=>{if(L.value<w.value.length-1&&L.value!==-1){const e=w.value[L.value+1];return e.id||e.lessonId}return null}),q=async()=>{if(R.value){B.push(`/course/${_.value}`);return}if(j.value){const e=`/course/${_.value}/blocks/${y.value}/lessons/${j.value}`;B.push(e)}},R=E(()=>L.value!==-1&&L.value===w.value.length-1);K(w,()=>{},{immediate:!0}),K([()=>b.params.courseId,()=>b.params.blocksId],([e,t])=>{e&&t&&S()}),K(()=>b.params.lessonId,e=>{if(e){const t=localStorage.getItem(`lesson_image_${e}`);if(t)a.value=t,localStorage.removeItem(`lesson_image_${e}`);else{const l=w.value.find(s=>(s.id||s.lessonId)===e);l&&(l.imageUrl||l.lessonImage)?a.value=x(l.imageUrl||l.lessonImage):a.value=""}}},{immediate:!0});const N=()=>{if(!A.value)return;const e=w.value.find(t=>(t.id||t.lessonId)===A.value);if(e&&(e.imageUrl||e.lessonImage)){const t=x(e.imageUrl||e.lessonImage);localStorage.setItem(`lesson_image_${A.value}`,t)}typeof J<"u"&&J.resetLessonState(h.value),B.push(`/course/${_.value}/blocks/${y.value}/lessons/${A.value}`)};return ne(()=>{h.value&&J.resetLessonState(h.value)}),G(async()=>{try{d.value=!0,await g(_.value);const e=await P();if(await S(),e&&e.imageUrl)a.value=x(e.imageUrl);else{const t=localStorage.getItem(`lesson_image_${h.value}`);t?a.value=t:a.value="/public/default-lesson.jpg"}}catch(e){f.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",e)}finally{d.value=!1}}),(e,t)=>{const l=V("v-progress-circular"),s=V("v-btn"),i=V("v-icon"),D=V("v-expansion-panel"),ee=V("v-expansion-panels"),te=V("v-container");return u(),U("div",he,[I(ie),I(te,{fluid:"",class:"content-container px-6 pt-2",width:M(C)?"100vw":"60vw"},{default:v(()=>[d.value?(u(),U("div",we,[I(l,{indeterminate:"",color:"#F48A21"})])):f.value?(u(),U("div",ke,F(f.value),1)):(u(),U("div",Ie,[n("div",be,[I(s,{class:"text-none secondary-action-btn",variant:"outlined",color:"#313131",text:"Назад",to:`/course/${_.value}/blocks/${y.value}`},null,8,["to"])]),n("div",xe,[n("div",Ue,[n("h2",$e,F(m.value.lessonTitle),1),I(ye,{"video-url":m.value.videoUrl,"poster-image":x(a.value)},null,8,["video-url","poster-image"]),n("div",Se,[I(s,{class:"text-none rounded-lg",width:M(C)?"40vw":"regular",variant:"outlined",onClick:N,disabled:!A.value},{default:v(()=>[M(C)?(u(),U(W,{key:0},[I(i,null,{default:v(()=>t[1]||(t[1]=[p("mdi-arrow-left")])),_:1}),t[2]||(t[2]=p(" Предыдущий "))],64)):(u(),U(W,{key:1},[p(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),I(s,{class:"text-none rounded-lg ml-4",width:M(C)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:t[0]||(t[0]=Ae=>q())},{default:v(()=>[M(C)?(u(),U(W,{key:0},[p(F(R.value?"Завершить":"Следующий")+" ",1),I(i,null,{default:v(()=>t[3]||(t[3]=[p("mdi-arrow-right")])),_:1})],64)):(u(),U(W,{key:1},[p(F(R.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])]),n("div",Le,[I(ee,{class:"w-100"},{default:v(()=>[m.value.description?(u(),T(D,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:v(()=>[n("div",Te,F(m.value.description||"Описание отсутствует"),1)]),_:1})):O("",!0),m.value.sheetUrl?(u(),T(D,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:v(()=>[n("p",Ce,[n("a",{href:m.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Pe)])]),_:1})):O("",!0)]),_:1})])])]))]),_:1},8,["width"]),I(ce)])}}}),Be=Z(Ee,[["__scopeId","data-v-0e7da695"]]);export{Be as default};
