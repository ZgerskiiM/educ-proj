import{d as ee,c as A,r as d,p as K,z as oe,o as u,b as k,f as r,B as ae,s as X,C as Y,k as N,i as T,w as a,g as v,t as D,n as ne,e as p,j as J,m as S,_ as te,u as re,x as z,D as ue,h as R,F as H,q as ie,l as ce}from"./index-D_rpuQft.js";import{H as ve,A as de}from"./AppFooter-CnV8umds.js";import{c as Z}from"./courseService-CWUEQpAO.js";import{c as me}from"./courseUserService-Ds0-JBWc.js";const b={started:new Set,completed:new Set,inProgress:new Set},G={isLessonStarted(n){return b.started.has(n)},markLessonAsStarted(n){b.started.add(n)},isLessonCompleted(n){return b.completed.has(n)},markLessonAsCompleted(n){b.completed.add(n)},isRequestInProgress(n){return b.inProgress.has(n)},startRequest(n){b.inProgress.add(n)},finishRequest(n){b.inProgress.delete(n)},resetLessonState(n){b.started.delete(n),b.completed.delete(n)},resetAllStates(){b.started.clear(),b.completed.clear(),b.inProgress.clear()}},pe=["poster"],fe=["src","type"],ge={class:"video-progress"},_e={class:"controls-main"},ye={class:"volume-control"},he={class:"time-display"},be=ee({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(n){const U=n,w=A(()=>{if(!U.videoUrl)return"video/avi";switch(U.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),B=l=>{if(!l)return"/public/default-lesson.jpg";let s=l.replace(/https:\/\/https:\/\//g,"https://");return s=s.replace(/https:\/\/https\//g,"https://"),s},o=d(null),i=d(null),x=d(!1),L=d(0),C=d(0),P=d(0),c=d(1),_=d(!1),m=d(!1),h=d(!0);let I=null;const f=()=>{h.value=!0,I&&clearTimeout(I),I=setTimeout(()=>{x.value&&(h.value=!1)},3e3)},g=()=>{o.value&&(x.value?o.value.pause():o.value.play(),x.value=!x.value,f())},$=()=>{o.value&&(L.value=o.value.currentTime,P.value=L.value/C.value*100)},F=()=>{o.value&&(C.value=o.value.duration)},j=()=>{if(!o.value)return;const l=P.value/100*C.value;o.value.currentTime=l},W=()=>{o.value&&(o.value.volume=c.value,_.value=c.value===0)},V=()=>{o.value&&(_.value?(_.value=!1,c.value=c.value===0?1:c.value,o.value.volume=c.value):(_.value=!0,o.value.volume=0))},M=()=>{i.value&&(document.fullscreenElement?(document.exitFullscreen(),m.value=!1):(i.value.requestFullscreen(),m.value=!0))},q=()=>{m.value=!!document.fullscreenElement},t=l=>{const s=Math.floor(l/60),y=Math.floor(l%60);return`${s}:${y<10?"0":""}${y}`},e=l=>{(document.activeElement===o.value||document.activeElement===i.value||m.value)&&(l.code==="Space"?(g(),l.preventDefault()):l.code==="ArrowRight"?(o.value&&(o.value.currentTime+=10),f()):l.code==="ArrowLeft"?(o.value&&(o.value.currentTime-=10),f()):l.code==="KeyM"?(V(),f()):l.code==="KeyF"&&(M(),f()))};return K(()=>{window.addEventListener("keydown",e),document.addEventListener("fullscreenchange",q),i.value&&i.value.addEventListener("mousemove",f),o.value&&(o.value.volume=c.value)}),oe(()=>{window.removeEventListener("keydown",e),document.removeEventListener("fullscreenchange",q),i.value&&i.value.removeEventListener("mousemove",f),I&&clearTimeout(I)}),(l,s)=>{const y=S("v-icon");return u(),k("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:i},[r("video",{ref_key:"videoPlayer",ref:o,onTimeupdate:$,onLoadedmetadata:F,onEnded:s[0]||(s[0]=E=>x.value=!1),onClick:g,poster:n.posterImage},[r("source",{src:B(n.videoUrl),type:w.value},null,8,fe)],40,pe),r("div",{class:ne(["video-controls",{"controls-visible":h.value}])},[r("div",ge,[r("div",{class:"progress-bar",style:ae({width:`${P.value}%`})},null,4),X(r("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":s[1]||(s[1]=E=>P.value=E),onInput:j},null,544),[[Y,P.value]])]),r("div",_e,[r("button",{class:"control-btn",onClick:N(g,["stop"])},[x.value?(u(),T(y,{key:1},{default:a(()=>s[4]||(s[4]=[v("mdi-pause")])),_:1})):(u(),T(y,{key:0},{default:a(()=>s[3]||(s[3]=[v("mdi-play")])),_:1}))]),r("div",ye,[r("button",{class:"control-btn",onClick:N(V,["stop"])},[_.value?(u(),T(y,{key:0},{default:a(()=>s[5]||(s[5]=[v("mdi-volume-off")])),_:1})):c.value<.5?(u(),T(y,{key:1},{default:a(()=>s[6]||(s[6]=[v("mdi-volume-low")])),_:1})):(u(),T(y,{key:2},{default:a(()=>s[7]||(s[7]=[v("mdi-volume-high")])),_:1}))]),X(r("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":s[2]||(s[2]=E=>c.value=E),onInput:W},null,544),[[Y,c.value]])]),r("div",he,D(t(L.value))+" / "+D(t(C.value)),1),r("button",{class:"control-btn fullscreen-btn",onClick:N(M,["stop"])},[m.value?(u(),T(y,{key:0},{default:a(()=>s[8]||(s[8]=[v("mdi-fullscreen-exit")])),_:1})):(u(),T(y,{key:1},{default:a(()=>s[9]||(s[9]=[v("mdi-fullscreen")])),_:1}))])])],2),x.value?J("",!0):(u(),k("div",{key:0,class:"big-play-button",onClick:N(g,["stop"])},[p(y,{size:"64"},{default:a(()=>s[10]||(s[10]=[v("mdi-play")])),_:1})]))],512)}}}),ke=te(be,[["__scopeId","data-v-2135aa7c"]]),we={class:"page-wrapper"},Ie={key:0,class:"d-flex justify-center my-5"},xe={key:1,class:"error-message"},Ue={key:2},Le={key:0,class:"breadcrumbs-container"},$e={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Se={class:"content-wrapper flex-column"},Te={class:"video-block mb-0 pt-0"},Ce={class:"font-weight-medium mb-3"},Pe={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Ee={class:"lesson-sidebar"},Ae=["innerHTML"],De={class:"font-weight-light"},Fe=["href"],Ve=ee({__name:"LessonPage",setup(n){const{mdAndDown:U}=re(),w=ie(),B=ce(),o=d(),i=d(""),x=d(""),L=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e};K(async()=>{const t=w.params.lessonId,e=localStorage.getItem(`lesson_image_${t}`);e&&(i.value=e,localStorage.removeItem(`lesson_image_${t}`)),await Promise.all([C(),M()]),!i.value&&m.value.imageUrl&&(i.value=L(m.value.imageUrl))});const C=async()=>{let e=0;for(;e<3;)try{c.value=!0;const l=await Z.getLessonDetails(f.value);return m.value=l,l}catch(l){if(e++,console.error(`Ошибка при загрузке урока (попытка ${e}/3):`,l),e>=3)throw _.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",l;await new Promise(s=>setTimeout(s,1e3*e))}finally{c.value=!1}},P=async t=>{if(t){c.value=!0,_.value="";try{const e=await me.fetchCourseWithBlocks(t);x.value=e.courseTitle||"Курс без названия",o.value=e.imageUrl}catch(e){console.error("Ошибка при загрузке курса:",e),_.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{c.value=!1}}};K(()=>{const t=w.params.courseId;t&&(h.value=t,P(t))});const c=d(!0),_=d(""),m=d({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),h=A(()=>w.params.courseId),I=A(()=>w.params.blocksId),f=A(()=>w.params.lessonId),g=d([]),$=A(()=>{const t=f.value?String(f.value):null;return g.value.findIndex(e=>{const l=e.id?String(e.id):null,s=e.lessonId?String(e.lessonId):null;return l===t||s===t})}),F=A(()=>{if($.value>0){const t=g.value[$.value-1];return t.id||t.lessonId}return null}),j=A(()=>{if($.value<g.value.length-1&&$.value!==-1){const t=g.value[$.value+1];return t.id||t.lessonId}return null});d(!1);const W=async()=>{if(V.value){B.push(`/course/${h.value}`);return}if(j.value){const t=`/course/${h.value}/blocks/${I.value}/lessons/${j.value}`;B.push(t)}},V=A(()=>$.value!==-1&&$.value===g.value.length-1);z(g,()=>{},{immediate:!0}),z([()=>w.params.courseId,()=>w.params.blocksId],([t,e])=>{t&&e&&M()});const M=async()=>{try{const t=await Z.getLessonsByBlockId(I.value);g.value=t||[]}catch(t){console.error("Ошибка при загрузке списка уроков:",t),_.value="Не удалось загрузить список уроков. Пожалуйста, попробуйте позже."}};z(()=>w.params.lessonId,(t,e)=>{t&&t!==e&&(m.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},c.value=!0,C())},{immediate:!0}),z(()=>w.params.lessonId,t=>{if(t){const e=localStorage.getItem(`lesson_image_${t}`);if(e)i.value=e,localStorage.removeItem(`lesson_image_${t}`);else{const l=g.value.find(s=>(s.id||s.lessonId)===t);l&&(l.imageUrl||l.lessonImage)?i.value=L(l.imageUrl||l.lessonImage):i.value=""}}},{immediate:!0});const q=()=>{if(!F.value){console.log("Нет предыдущего урока");return}const t=g.value.find(e=>(e.id||e.lessonId)===F.value);if(t&&(t.imageUrl||t.lessonImage)){const e=L(t.imageUrl||t.lessonImage);console.log("Сохраняем изображение предыдущего урока:",e),localStorage.setItem(`lesson_image_${F.value}`,e)}typeof G<"u"&&G.resetLessonState(f.value),B.push(`/course/${h.value}/blocks/${I.value}/lessons/${F.value}`)};return ue(()=>{f.value&&G.resetLessonState(f.value)}),K(async()=>{try{c.value=!0,await P(h.value);const t=await C();if(await M(),t&&t.imageUrl)i.value=L(t.imageUrl);else{const e=localStorage.getItem(`lesson_image_${f.value}`);e?i.value=e:i.value="/public/default-lesson.jpg"}}catch(t){_.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",t)}finally{c.value=!1}}),(t,e)=>{const l=S("v-progress-circular"),s=S("v-breadcrumbs-item"),y=S("v-breadcrumbs"),E=S("v-btn"),O=S("v-icon"),Q=S("v-expansion-panel"),se=S("v-expansion-panels"),le=S("v-container");return u(),k("div",we,[p(ve),p(le,{fluid:"",class:"content-container px-6 pt-2",width:R(U)?"100vw":"60vw"},{default:a(()=>[c.value?(u(),k("div",Ie,[p(l,{indeterminate:"",color:"#F48A21"})])):_.value?(u(),k("div",xe,D(_.value),1)):(u(),k("div",Ue,[R(U)?(u(),k("div",$e,[p(E,{variant:"outlined",density:"comfortable",to:`/course/${h.value}/blocks/${I.value}`,class:"back-button text-none"},{default:a(()=>e[3]||(e[3]=[v(" К урокам ")])),_:1},8,["to"])])):(u(),k("div",Le,[p(y,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:a(()=>[p(s,{to:"/lk"},{default:a(()=>e[1]||(e[1]=[v("Профиль")])),_:1}),p(s,{to:`/course/${h.value}`},{default:a(()=>[v(D(x.value),1)]),_:1},8,["to"]),p(s,{to:`/course/${h.value}/blocks/${I.value}`},{default:a(()=>e[2]||(e[2]=[v("Уроки")])),_:1},8,["to"]),p(s,{disabled:""},{default:a(()=>[v(D(m.value.lessonTitle),1)]),_:1})]),_:1})])),r("div",Se,[r("div",Te,[r("h2",Ce,D(m.value.lessonTitle),1),p(ke,{"video-url":m.value.videoUrl,"poster-image":L(i.value)},null,8,["video-url","poster-image"]),r("div",Pe,[p(E,{class:"text-none rounded-lg",width:R(U)?"40vw":"regular",variant:"outlined",onClick:q,disabled:!F.value},{default:a(()=>[R(U)?(u(),k(H,{key:0},[p(O,null,{default:a(()=>e[4]||(e[4]=[v("mdi-arrow-left")])),_:1}),e[5]||(e[5]=v(" Предыдущий "))],64)):(u(),k(H,{key:1},[v(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),p(E,{class:"text-none rounded-lg ml-4",width:R(U)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:e[0]||(e[0]=Me=>W())},{default:a(()=>[R(U)?(u(),k(H,{key:0},[v(D(V.value?"Завершить":"Следующий")+" ",1),p(O,null,{default:a(()=>e[6]||(e[6]=[v("mdi-arrow-right")])),_:1})],64)):(u(),k(H,{key:1},[v(D(V.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width"])])]),r("div",Ee,[p(se,{class:"w-100"},{default:a(()=>[m.value.description?(u(),T(Q,{class:"w-100",key:"1",title:"01 / Описание урока"},{text:a(()=>[r("div",{class:"font-weight-light",innerHTML:m.value.description||"Описание отсутствует"},null,8,Ae)]),_:1})):J("",!0),m.value.sheetUrl?(u(),T(Q,{class:"w-100",key:"2",title:"02 / Дополнительные материалы"},{text:a(()=>[r("p",De,[r("a",{href:m.value.sheetUrl,target:"_blank",class:"material-link"}," Скачать материалы к уроку ",8,Fe)])]),_:1})):J("",!0)]),_:1})])])]))]),_:1},8,["width"]),p(de)])}}}),Ne=te(Ve,[["__scopeId","data-v-8ba5ce64"]]);export{Ne as default};
