import{d as Z,c as T,r as u,p as W,z as le,o as i,b as k,f as d,B as oe,s as Q,C as X,k as K,i as E,w as n,g as r,t as C,n as ae,e as f,j as ne,m as A,_ as ee,u as re,x as V,D as ue,h as R,F as H,q as ie,l as ve}from"./index-DqudrVho.js";import{H as ce,A as de}from"./AppFooter-Du173oWm.js";import{c as Y}from"./courseService-qwU_nXwg.js";import{c as me}from"./courseUserService-WOEUTbAa.js";const b={started:new Set,completed:new Set,inProgress:new Set},J={isLessonStarted(a){return b.started.has(a)},markLessonAsStarted(a){b.started.add(a)},isLessonCompleted(a){return b.completed.has(a)},markLessonAsCompleted(a){b.completed.add(a)},isRequestInProgress(a){return b.inProgress.has(a)},startRequest(a){b.inProgress.add(a)},finishRequest(a){b.inProgress.delete(a)},resetLessonState(a){b.started.delete(a),b.completed.delete(a)},resetAllStates(){b.started.clear(),b.completed.clear(),b.inProgress.clear()}},fe=["poster"],pe=["src","type"],ge={class:"video-progress"},ye={class:"controls-main"},_e={class:"volume-control"},be={class:"time-display"},ke=Z({__name:"VideoPlayer",props:{videoUrl:{type:String,default:""},posterImage:{type:String,default:""}},setup(a){const L=a,_=T(()=>{if(!L.videoUrl)return"video/avi";switch(L.videoUrl.split(".").pop().toLowerCase()){case"mp4":return"video/mp4";case"webm":return"video/webm";case"ogg":return"video/ogg";case"avi":return"video/avi";case"mov":return"video/quicktime";default:return"video/mp4"}}),j=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e},l=u(null),v=u(null),I=u(!1),x=u(0),U=u(0),S=u(0),o=u(1),p=u(!1),g=u(!1),h=u(!0);let w=null;const c=()=>{h.value=!0,w&&clearTimeout(w),w=setTimeout(()=>{I.value&&(h.value=!1)},3e3)},y=()=>{l.value&&(I.value?l.value.pause():l.value.play(),I.value=!I.value,c())},$=()=>{l.value&&(x.value=l.value.currentTime,S.value=x.value/U.value*100)},P=()=>{l.value&&(U.value=l.value.duration)},B=()=>{if(!l.value)return;const t=S.value/100*U.value;l.value.currentTime=t},M=()=>{l.value&&(l.value.volume=o.value,p.value=o.value===0)},q=()=>{l.value&&(p.value?(p.value=!1,o.value=o.value===0?1:o.value,l.value.volume=o.value):(p.value=!0,l.value.volume=0))},D=()=>{v.value&&(document.fullscreenElement?(document.exitFullscreen(),g.value=!1):(v.value.requestFullscreen(),g.value=!0))},N=()=>{g.value=!!document.fullscreenElement},F=t=>{const e=Math.floor(t/60),s=Math.floor(t%60);return`${e}:${s<10?"0":""}${s}`},z=t=>{(document.activeElement===l.value||document.activeElement===v.value||g.value)&&(t.code==="Space"?(y(),t.preventDefault()):t.code==="ArrowRight"?(l.value&&(l.value.currentTime+=10),c()):t.code==="ArrowLeft"?(l.value&&(l.value.currentTime-=10),c()):t.code==="KeyM"?(q(),c()):t.code==="KeyF"&&(D(),c()))};return W(()=>{window.addEventListener("keydown",z),document.addEventListener("fullscreenchange",N),v.value&&v.value.addEventListener("mousemove",c),l.value&&(l.value.volume=o.value)}),le(()=>{window.removeEventListener("keydown",z),document.removeEventListener("fullscreenchange",N),v.value&&v.value.removeEventListener("mousemove",c),w&&clearTimeout(w)}),(t,e)=>{const s=A("v-icon");return i(),k("div",{class:"video-container mb-5",ref_key:"videoContainer",ref:v},[d("video",{ref_key:"videoPlayer",ref:l,onTimeupdate:$,onLoadedmetadata:P,onEnded:e[0]||(e[0]=m=>I.value=!1),onClick:y,poster:a.posterImage},[d("source",{src:j(a.videoUrl),type:_.value},null,8,pe)],40,fe),d("div",{class:ae(["video-controls",{"controls-visible":h.value}])},[d("div",ge,[d("div",{class:"progress-bar",style:oe({width:`${S.value}%`})},null,4),Q(d("input",{type:"range",class:"progress-seek",min:"0",max:"100",step:"0.1","onUpdate:modelValue":e[1]||(e[1]=m=>S.value=m),onInput:B},null,544),[[X,S.value]])]),d("div",ye,[d("button",{class:"control-btn",onClick:K(y,["stop"])},[I.value?(i(),E(s,{key:1},{default:n(()=>e[4]||(e[4]=[r("mdi-pause")])),_:1})):(i(),E(s,{key:0},{default:n(()=>e[3]||(e[3]=[r("mdi-play")])),_:1}))]),d("div",_e,[d("button",{class:"control-btn",onClick:K(q,["stop"])},[p.value?(i(),E(s,{key:0},{default:n(()=>e[5]||(e[5]=[r("mdi-volume-off")])),_:1})):o.value<.5?(i(),E(s,{key:1},{default:n(()=>e[6]||(e[6]=[r("mdi-volume-low")])),_:1})):(i(),E(s,{key:2},{default:n(()=>e[7]||(e[7]=[r("mdi-volume-high")])),_:1}))]),Q(d("input",{type:"range",class:"volume-slider",min:"0",max:"1",step:"0.1","onUpdate:modelValue":e[2]||(e[2]=m=>o.value=m),onInput:M},null,544),[[X,o.value]])]),d("div",be,C(F(x.value))+" / "+C(F(U.value)),1),d("button",{class:"control-btn fullscreen-btn",onClick:K(D,["stop"])},[g.value?(i(),E(s,{key:0},{default:n(()=>e[8]||(e[8]=[r("mdi-fullscreen-exit")])),_:1})):(i(),E(s,{key:1},{default:n(()=>e[9]||(e[9]=[r("mdi-fullscreen")])),_:1}))])])],2),I.value?ne("",!0):(i(),k("div",{key:0,class:"big-play-button",onClick:K(y,["stop"])},[f(s,{size:"64"},{default:n(()=>e[10]||(e[10]=[r("mdi-play")])),_:1})]))],512)}}}),he=ee(ke,[["__scopeId","data-v-2135aa7c"]]),we={class:"page-wrapper"},Ie={key:0,class:"d-flex justify-center my-5"},Ue={key:1,class:"error-message"},Le={key:2},xe={key:0,class:"breadcrumbs-container"},$e={key:1,class:"back-button-container pt-4 pb-2 pl-0 ml-0"},Se={class:"content-wrapper flex-column"},Te={class:"video-block mb-0 pt-0"},Ce={class:"font-weight-medium mb-3"},Pe={class:"nav--buttons pt-0 mt-0 mb-1 d-flex justify-end"},Ee=Z({__name:"LessonPage",setup(a){const{mdAndDown:L}=re(),_=ie(),j=ve(),l=u(),v=u(""),I=u(""),x=t=>{if(!t)return"/public/default-lesson.jpg";let e=t.replace(/https:\/\/https:\/\//g,"https://");return e=e.replace(/https:\/\/https\//g,"https://"),e};W(async()=>{const t=_.params.lessonId,e=localStorage.getItem(`lesson_image_${t}`);e&&(v.value=e,localStorage.removeItem(`lesson_image_${t}`)),await Promise.all([U(),F()]),!v.value&&g.value.imageUrl&&(v.value=x(g.value.imageUrl))});const U=async()=>{let e=0;for(;e<3;)try{o.value=!0;const s=await Y.getLessonDetails(c.value);return g.value=s,s}catch(s){if(e++,console.error(`Ошибка при загрузке урока (попытка ${e}/3):`,s),e>=3)throw p.value="Не удалось загрузить урок. Пожалуйста, проверьте подключение к интернету и попробуйте снова.",s;await new Promise(m=>setTimeout(m,1e3*e))}finally{o.value=!1}},S=async t=>{if(t){o.value=!0,p.value="";try{const e=await me.fetchCourseWithBlocks(t);I.value=e.courseTitle||"Курс без названия",l.value=e.imageUrl}catch(e){console.error("Ошибка при загрузке курса:",e),p.value="Не удалось загрузить данные курса. Пожалуйста, попробуйте позже."}finally{o.value=!1}}};W(()=>{const t=_.params.courseId;t&&(h.value=t,S(t))});const o=u(!0),p=u(""),g=u({lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""}),h=T(()=>_.params.courseId),w=T(()=>_.params.blocksId),c=T(()=>_.params.lessonId),y=u([]),$=T(()=>{const t=c.value?String(c.value):null;return y.value.findIndex(e=>{const s=e.id?String(e.id):null,m=e.lessonId?String(e.lessonId):null;return s===t||m===t})}),P=T(()=>{if($.value>0){const t=y.value[$.value-1];return t.id||t.lessonId}return null}),B=T(()=>{if($.value<y.value.length-1&&$.value!==-1){const t=y.value[$.value+1];return t.id||t.lessonId}return null}),M=u(!1),q=async()=>{if(!B.value){console.log("Нет следующего урока");return}if(B.value){const t=`/course/${h.value}/blocks/${w.value}/lessons/${B.value}`;j.push(t)}},D=T(()=>$.value!==-1&&$.value===y.value.length-1);V(()=>_.params.lessonId,(t,e)=>{M.value=!1,t&&t!==e&&(g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},o.value=!0,setTimeout(()=>{U()},100))},{immediate:!0}),V(y,()=>{},{immediate:!0}),V([()=>_.params.courseId,()=>_.params.blocksId],([t,e])=>{t&&e&&F()});const N=u(!1),F=async()=>{try{const t=await Y.getLessonsByBlockId(w.value);y.value=t||[],c.value&&!M.value&&startLesson(c.value)}catch(t){console.error("Ошибка при загрузке списка уроков:",t),p.value="Не удалось загрузить список уроков. Пожалуйста, попробуйте позже."}};V(()=>_.params.lessonId,(t,e)=>{t&&t!==e&&(g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:""},o.value=!0,U())},{immediate:!0}),V(()=>_.params.lessonId,t=>{if(t){const e=localStorage.getItem(`lesson_image_${t}`);if(e)v.value=e,localStorage.removeItem(`lesson_image_${t}`);else{const s=y.value.find(m=>(m.id||m.lessonId)===t);s&&(s.imageUrl||s.lessonImage)?v.value=x(s.imageUrl||s.lessonImage):v.value=""}}},{immediate:!0});const z=()=>{if(!P.value){console.log("Нет предыдущего урока");return}const t=y.value.find(e=>(e.id||e.lessonId)===P.value);if(t&&(t.imageUrl||t.lessonImage)){const e=x(t.imageUrl||t.lessonImage);console.log("Сохраняем изображение предыдущего урока:",e),localStorage.setItem(`lesson_image_${P.value}`,e)}typeof J<"u"&&J.resetLessonState(c.value),j.push(`/course/${h.value}/blocks/${w.value}/lessons/${P.value}`)};return ue(()=>{c.value&&J.resetLessonState(c.value)}),W(async()=>{try{o.value=!0,await S(h.value);const t=await U();if(await F(),t&&t.imageUrl)v.value=x(t.imageUrl);else{const e=localStorage.getItem(`lesson_image_${c.value}`);e?v.value=e:v.value="/public/default-lesson.jpg"}}catch(t){p.value="Ошибка при загрузке урока. Попробуйте обновить страницу.",console.error("Ошибка загрузки:",t)}finally{o.value=!1}}),V(()=>_.params.lessonId,async(t,e)=>{if(t&&t!==e){o.value=!0,p.value="",M.value=!1;try{g.value={lessonTitle:"",videoUrl:"",description:"",sheetUrl:"",imageUrl:""},await U()}catch{p.value="Не удалось загрузить урок. Попробуйте еще раз."}finally{o.value=!1}}},{immediate:!0}),(t,e)=>{const s=A("v-progress-circular"),m=A("v-breadcrumbs-item"),te=A("v-breadcrumbs"),G=A("v-btn"),O=A("v-icon"),se=A("v-container");return i(),k("div",we,[f(ce),f(se,{fluid:"",class:"content-container px-6 pt-2",width:R(L)?"100vw":"60vw"},{default:n(()=>[o.value?(i(),k("div",Ie,[f(s,{indeterminate:"",color:"#F48A21"})])):p.value?(i(),k("div",Ue,C(p.value),1)):(i(),k("div",Le,[R(L)?(i(),k("div",$e,[f(G,{variant:"outlined",density:"comfortable",to:`/course/${h.value}/blocks/${w.value}`,class:"back-button text-none"},{default:n(()=>e[3]||(e[3]=[r(" К урокам ")])),_:1},8,["to"])])):(i(),k("div",xe,[f(te,{class:"mb-1 pl-0 font-weight-light",color:"#F48A21"},{default:n(()=>[f(m,{to:"/lk"},{default:n(()=>e[1]||(e[1]=[r("Профиль")])),_:1}),f(m,{to:`/course/${h.value}`},{default:n(()=>[r(C(I.value),1)]),_:1},8,["to"]),f(m,{to:`/course/${h.value}/blocks/${w.value}`},{default:n(()=>e[2]||(e[2]=[r("Уроки")])),_:1},8,["to"]),f(m,{disabled:""},{default:n(()=>[r(C(g.value.lessonTitle),1)]),_:1})]),_:1})])),d("div",Se,[d("div",Te,[d("h2",Ce,C(g.value.lessonTitle),1),f(he,{"video-url":g.value.videoUrl,"poster-image":x(l.value.value)},null,8,["video-url","poster-image"]),d("div",Pe,[f(G,{class:"text-none rounded-lg",width:R(L)?"40vw":"regular",variant:"outlined",onClick:z,disabled:!P.value},{default:n(()=>[R(L)?(i(),k(H,{key:0},[f(O,null,{default:n(()=>e[4]||(e[4]=[r("mdi-arrow-left")])),_:1}),e[5]||(e[5]=r(" Предыдущий "))],64)):(i(),k(H,{key:1},[r(" Предыдущий урок ")],64))]),_:1},8,["width","disabled"]),f(G,{class:"text-none rounded-lg ml-4",width:R(L)?"40vw":"regular",variant:"outlined",color:"#333132",onClick:e[0]||(e[0]=Ae=>D.value?t.completeLastLesson():q()),loading:N.value},{default:n(()=>[R(L)?(i(),k(H,{key:0},[r(C(D.value?"Завершить":"Следующий")+" ",1),f(O,null,{default:n(()=>e[6]||(e[6]=[r("mdi-arrow-right")])),_:1})],64)):(i(),k(H,{key:1},[r(C(D.value?"Завершить блок":"Следующий урок"),1)],64))]),_:1},8,["width","loading"])])])])]))]),_:1},8,["width"]),f(de)])}}}),Be=ee(Ee,[["__scopeId","data-v-a0a66c7c"]]);export{Be as default};
